<!DOCTYPE html> 
<html>
<head>
    <link rel="stylesheet" type="text/css" href="static/css/draw.css">
  <script src="static/js/jquery-3.3.1.min.js"></script>
    <script src="static/js/rect.js"></script>
    	<link rel="stylesheet" type="text/css" href="static/codebase/fonts/font_roboto/roboto.css"/>
	<link rel="stylesheet" type="text/css" href="static/codebase/dhtmlx.css"/>
    <link rel="stylesheet" type="text/css" href="static/css/treetable.css"/>
    <script src="static/js/jquery-ui.min.js"></script> 
	<script src="static/codebase/dhtmlx.js"></script>
  <script>
  
        var False = false;
        var True = true;
        var None = null;
        
        var curr_mouse_y=0;
  
        var menu_is_open = false;
  		var dhxWins;
        var ttMenu;
        var ttWIndow_isOpen = false;

        var old_thumbnail_screen = null;
        
        var selected_box = null;
        
        var canvas_sorting_ids = [];
        
        var hidden_thumbnail = [];
        
        var rows_html = [];
        
        var object_name = "{{object_name}}";
        
        key_ctrl_pressed = false;
        
        var detection = {
            "type": "appear",
            "timeout_s": 10,
            "break": true
        }
        
        var old_win = 0;
        
        var old_win_h = 0;
        var old_win_w = 0;
        var old_win_x = 0;
        var old_win_y = 0;
        
        var sorting_rows_dict = [];
        
		function doOnLoad() {
			dhxWins = new dhtmlXWindows();
            
        }
        
        function clone(obj) {
            if (null == obj || "object" != typeof obj) return obj;
            var copy = obj.constructor();
            for (var attr in obj) {
                if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
            }
            return copy;
        }
        
        function save()
        {
            var jsonData = JSON.stringify({object_name:object_name, detection: detection, box_list:boxes, background: background_base64_string});
            
            $.ajax({
                url: "/save_json",
                type: "POST",
                data: jsonData,
                contentType: "application/json; charset=utf-8",
                success: function(dat) { //alert("JSON SAVED");
                        $.ajax({
                            url: "/cancel_event",
                            type: "GET",
                            success: function(dat) { alert("JSON SAVED");}
                        });
                }
            });
        }
        
        function cancel()
        {
            
            $.ajax({
                url: "/cancel_event",
                type: "GET",
                success: function(dat) { alert("JSON SAVED");}
            });
            window.history.back();
        }
		
		var idPrefix = 1;
		function createWindow() {
        
            rectManager.key_ctrl_pressed = false;
        
            ttWIndow_isOpen = true;
            draw(rectManager.last_mouse_event);
        
            selected_box = null;
                    
            $("#myCanvas").unbind("mousemove");
            
            $("#myCanvas").unbind("mousedown");
            
            $("#myCanvas").mousedown(function(e){
             
                             
                dhxWins.forEachWindow(function(win){win.close();});
             
            });
            
            $("#myCanvas").unbind("mouseup");
            
            $("body").unbind("keydown");
            
            $("body").unbind("keyup");
            
            $("body").keydown(function(e){
            
                    console.log("sd");
                    
                    if (selected_box == null) return;
            
                    if (e.key == "Control") key_ctrl_pressed = true;
                    
                    if (selected_box == -1)
                    {
                        if (key_ctrl_pressed == true && e.key == "x") {context_menu_event("rem_all"); console.log("ctx");}
                        
                        else if (this.key_ctrl_pressed == true && e.key == "n") context_menu_event("new_component");
                    }
                    else if(boxes[selected_box].is_main)
                    {
                        if (key_ctrl_pressed == true && e.key == "x") context_menu_event("rem_group");
                        
                        else if (key_ctrl_pressed == true && e.key == "d") context_menu_event("dupl_group");
                        
                        else if (key_ctrl_pressed == true && e.key == "i") context_menu_event("detect_as_img");
                        
                        else if (key_ctrl_pressed == true && e.key == "r") context_menu_event("detect_as_rect");
                        
                        else if (key_ctrl_pressed == true && e.key == "t") context_menu_event("detect_as_text");
                        
                        else if (this.key_ctrl_pressed == true && e.key == "n") context_menu_event("new_component");
                    }
                    else
                    {
                        if (key_ctrl_pressed == true && e.key == "x") context_menu_event("remove_comp");
                        
                        else if (key_ctrl_pressed == true && e.key == "d") context_menu_event("dupl_comp");
                        
                        else if (key_ctrl_pressed == true && e.key == "i") context_menu_event("detect_as_img");
                        
                        else if (key_ctrl_pressed == true && e.key == "r") context_menu_event("detect_as_rect");
                        
                        else if (key_ctrl_pressed == true && e.key == "t") context_menu_event("detect_as_text");
                        
                        else if (this.key_ctrl_pressed == true && e.key == "n") context_menu_event("new_component");
                    }

                    
            });
            
            $("body").keyup(function(e){

                if (e.key == "Control") key_ctrl_pressed = false;
            });
            
			var p = 0;
			dhxWins.forEachWindow(function(){p++;});
			if (p>=1) {
				//alert("Too many windows");
				return;
			}
			var id = "userWin"+(idPrefix++);
			//
			var w = 400;
            
            var h = 640;
            if (screen_h < 640)
            {
                h = screen_h;
            }

			var x = parseInt( ({{img_w}}/2) - (w/2) );
			var y = 70;
            
            if (old_win_h != 0) h = old_win_h;
            if (old_win_w != 0) w = old_win_w;
            if (old_win_x != 0) x = old_win_x;            
            if (old_win_y != 0) y = old_win_y;

            
			//
			dhxWins.createWindow(id, x, y, w, h);
            dhxWins.window(id).attachEvent('onClose', closeWinEvent);
            
			dhxWins.window(id).setText("ALYVIX DESIGNER");
            dhxWins.window(id).appendObject("tt_window");
            
            adjust_win_size(dhxWins.window(id));
            
            old_win = dhxWins.window(id);
            
            dhxWins.window(id).attachEvent("onResizeFinish", function(win){
            
                adjust_win_size(win);

            });
            
            dhxWins.window(id).attachEvent("onBeforeResizeStart", function(win){
                // your code here
                return true; // allow window resizing to be started
            });
            
            dhxWins.window(id).setMaxDimension(w, screen_h - 100);
            dhxWins.window(id).setMinDimension(400, 350);

            
			// dhxWins.window(id).keepInViewport(true);
                        
                        
            // init Menu

            //ttMenu.addContextZone("tt_row");
			//
           
	
		}
        
        function adjust_win_size(win = null){
        
            if (win==null) win = old_win;
            var dimension = win.getDimension();
            
            //$("#tt_window_table").height(dimension[1]);
            
            var first_div_h = 0
            if($("#object_name_option").is(":visible")) first_div_h +=  $("#object_name_option").height() ;
            
            if($("#app_disapp_option").is(":visible")) first_div_h +=  $("#app_disapp_option").height() ;
            
            if($("#timeout_option").is(":visible")) first_div_h +=  $("#timeout_option").height() ;



            var third_div_h = 0;
            
            if($("#add_irt_button").is(":visible")) third_div_h +=  $("#add_irt_button").height() ;
            
            if($("#detection_option").is(":visible")) third_div_h +=  $("#detection_option").height() ;
            
            if($("#interaction_mouse_option").is(":visible")) third_div_h +=  $("#interaction_mouse_option").height() ;
            
            if($("#interaction_keyboard_option").is(":visible")) third_div_h +=  $("#interaction_keyboard_option").height() ;

            if($("#ok_cancel").is(":visible")) third_div_h +=  $("#ok_cancel").height() ;


            $("#tt_row").height(dimension[1]-50 - (first_div_h + third_div_h));

            
            old_win_h = dimension[1];
            old_win_w = dimension[0];
            
                          
            $("#tt_window").height(dimension[1]-50);
            
            $("#tt_window_table").height(dimension[1]-50);

            
            console.log("dimension" + dimension);
        }
        
        function closeWinEvent(win)
        {
            var dimension = win.getDimension();
            var pos = win.getPosition();
        
            old_win_h = dimension[1];
            old_win_w = dimension[0];
            
            old_win_x = pos[0];
            old_win_y = pos[1];
        
            ttWIndow_isOpen = false;
            //$("#myCanvas").unbind("mousedown");
            $("#myCanvas").mousemove(function(e){handleMouseMove(e);});
            
            $("#myCanvas").mousedown(function(e){rectManager.mousedown(e);});
            
            $("#myCanvas").mouseup(function(e){rectManager.mouseup(e);});
            
            $("body").keydown (function(e){rectManager.keydown(e);});
            
            $("body").keyup(function(e){rectManager.keyup(e);});
            
            //alert("unload");
            win.detachObject();
            return true;
        }
		
		function doOnUnload() {
			if (dhxWins != null && dhxWins.unload != null) {
                dhxWins.forEachWindow(function(window){window.detachObject(true);});
				dhxWins.unload();
				dhxWins = null;
			}
		}
        function context_menu_event(id)
        {
        
            if(id == 'rem_group')
            {
                var group = boxes[selected_box].group;
                
                var new_rects = [];
                var thumbnails = []

                
                for (var i=0; i<boxes.length; i++)
                {
                    if(boxes[i].group != group)
                    {
                        new_rects.push(boxes[i]);
                        thumbnails.push(boxes[i].thumbnail);
                    }
                }

                if(group==0){
                    rectManager.main_g0_created = false;
                    rectManager.g0_elements_cnt = 0;
                }

                if(group==1){
                    rectManager.main_g1_created = false;
                    rectManager.g1_elements_cnt = 0;
                }

                if(group==2){
                    rectManager.main_g2_created = false;
                    rectManager.g2_elements_cnt = 0;
                }

                rectManager.set_rectangles(new_rects);
                boxes = rectManager.get_rectangles();
                
                draw(rectManager.last_mouse_event);
                createTreeTable({"thumbnails":thumbnails, "screen": old_thumbnail_screen});
                
                
            }
            else if(id == 'dupl_group')
            {
                console.log('dupl group');
                
                var group_from = boxes[selected_box].group;
                
                var group_to = null;
                
                if (rectManager.main_g0_created == false) {
                    group_to = 0;
                }
                else if (rectManager.main_g1_created == false) {
                    group_to = 1;
                }
                else if (rectManager.main_g2_created == false) {
                    group_to = 2;
                }
                
                for (var i =0; i<boxes.length; i++)
                {
                    if (boxes[i].group == group_from)
                    {
                        var box = new Box(boxes[i].x, boxes[i].y, boxes[i].w, boxes[i].h, boxes[i].roi_x, boxes[i].roi_y, boxes[i].roi_w, boxes[i].roi_h);

                        box.roi_unlimited_left = boxes[i].roi_unlimited_left;
                        box.roi_unlimited_up = boxes[i].roi_unlimited_up;
                        box.roi_unlimited_right = boxes[i].roi_unlimited_right;
                        box.roi_unlimited_down = boxes[i].roi_unlimited_down;
                        box.is_main = boxes[i].is_main;
                        box.group = group_to;
                        box.thumbnail = {};

                        box.thumbnail["x"] = boxes[i].thumbnail["x"];
                        box.thumbnail["y"] = boxes[i].thumbnail["y"];
                        box.thumbnail["h"] = boxes[i].thumbnail["h"];
                        box.thumbnail["w"] = boxes[i].thumbnail["w"];
                        box.thumbnail["group"] = group_to;
                        box.thumbnail["is_main"] = boxes[i].thumbnail["is_main"];
                        box.thumbnail["image"] = boxes[i].thumbnail["image"];
                        box.thumbnail["image_w"] = boxes[i].thumbnail["image_w"];
                        
                        box.thumbnail["image_h"] = boxes[i].thumbnail["image_h"];
                        
                        box.type = boxes[i].type;
                        
                        box.features = {"I":{},
                                        "R":{},
                                        "T":{}};
                        try{
                            box.features["I"]["colors"] = boxes[i].features["I"]["colors"];
                            box.features["I"]["likelihood"] = boxes[i].features["I"]["likelihood"];
                        }
                        catch(err)
                        {}
                        
                        try{
                            box.features["R"]["width"]["min"] = boxes[i].features["R"]["width"]["min"];
                            box.features["R"]["width"]["max"] = boxes[i].features["R"]["width"]["max"];
                            box.features["R"]["height"]["min"] = boxes[i].features["R"]["height"]["min"];
                            box.features["R"]["height"]["max"] = boxes[i].features["R"]["height"]["max"];
                        }
                        catch(err)
                        {}
                        
                        try{
                            box.features["T"]["regexp"] = boxes[i].features["T"]["regexp"];
                            box.features["T"]["whitelist"] = boxes[i].features["T"]["whitelist"];
                            box.features["T"]["dictionary"] = boxes[i].features["T"]["dictionary"];
                        }
                        catch(err)
                        {}
                        
                        //box.mouse = boxes[i].mouse;
                        
                        box.mouse = {"type": null, "features": {"point": { "dx": 0, "dy": 0 }}};
                        
                        box.mouse["type"] = boxes[i].mouse["type"];
                        box.mouse["features"]["point"]["dx"] = boxes[i].mouse["features"]["point"]["dx"];
                        box.mouse["features"]["point"]["dy"] = boxes[i].mouse["features"]["point"]["dy"];
                        
                        //box.keyboard = boxes[i].keyboard;
                        box.keyboard = {"string": "", "delays_ms": 100, "durations_ms": 100};
                        box.keyboard["string"] = boxes[i].keyboard["string"];
                        box.keyboard["delays_ms"] = boxes[i].keyboard["delays_ms"];
                        box.keyboard["durations_ms"] = boxes[i].keyboard["durations_ms"];

                
                
                        boxes.push(box)
                        
                        if (box.is_main == true )
                        {
                            
                            if(group_to==0) rectManager.main_g0_created = true;

                            if(group_to==1) rectManager.main_g1_created = true;

                            if(group_to==2) rectManager.main_g2_created = true;
                        }
                        
                        if(group_to==0) rectManager.g0_elements_cnt+=1;
                    
                        if(group_to==1) rectManager.g1_elements_cnt+=1;
                    
                        if(group_to==2) rectManager.g2_elements_cnt+=1;
                    
                    }
                }
                
                var thumbnails = [];

                var boxes_g0 = [];
                var boxes_g1 = [];
                var boxes_g2 = [];
                
                for (var i=0; i<boxes.length; i++)
                {
                    if(boxes[i].group == 0) boxes_g0.push(boxes[i]);
                    
                    if(boxes[i].group == 1) boxes_g1.push(boxes[i]);
                    
                    if(boxes[i].group == 2) boxes_g2.push(boxes[i]);
                }
                
                boxes = [];
                
                boxes = boxes.concat(boxes_g0, boxes_g1, boxes_g2);
                
                                    
                 
                for (var i =0; i<boxes.length; i++)
                {
                    thumbnails.push(boxes[i].thumbnail);
                }
                
                
                rectManager.set_rectangles(boxes);
                //boxes = rectManager.get_rectangles();
                                    
                draw(rectManager.last_mouse_event);
                createTreeTable({"thumbnails":thumbnails, "screen": old_thumbnail_screen});
            }
            else if(id == 'dupl_comp')
            {
                console.log('dupl comp');

                var box = new Box(boxes[selected_box].x, boxes[selected_box].y, boxes[selected_box].w, boxes[selected_box].h, boxes[selected_box].roi_x, boxes[selected_box].roi_y, boxes[selected_box].roi_w, boxes[selected_box].roi_h);

                box.roi_unlimited_left = boxes[selected_box].roi_unlimited_left;
                box.roi_unlimited_up = boxes[selected_box].roi_unlimited_up;
                box.roi_unlimited_right = boxes[selected_box].roi_unlimited_right;
                box.roi_unlimited_down = boxes[selected_box].roi_unlimited_down;
                box.is_main = boxes[selected_box].is_main;
                box.group = boxes[selected_box].group;
                box.thumbnail = {};

                box.thumbnail["x"] = boxes[selected_box].thumbnail["x"];
                box.thumbnail["y"] = boxes[selected_box].thumbnail["y"];
                box.thumbnail["h"] = boxes[selected_box].thumbnail["h"];
                box.thumbnail["w"] = boxes[selected_box].thumbnail["w"];
                box.thumbnail["group"] = boxes[selected_box].thumbnail["group"];
                box.thumbnail["is_main"] = boxes[selected_box].thumbnail["is_main"];
                box.thumbnail["image"] = boxes[selected_box].thumbnail["image"];
                box.thumbnail["image_w"] = boxes[selected_box].thumbnail["image_w"];
                
                box.thumbnail["image_h"] = boxes[selected_box].thumbnail["image_h"];
                
                box.type = boxes[selected_box].type;
                
                box.features = {"I":{},
                                "R":{},
                                "T":{}};
                try{
                    box.features["I"]["colors"] = boxes[selected_box].features["I"]["colors"];
                    box.features["I"]["likelihood"] = boxes[selected_box].features["I"]["likelihood"];
                }
                catch(err)
                {}
                
                try{
                    box.features["R"]["width"]["min"] = boxes[selected_box].features["R"]["width"]["min"];
                    box.features["R"]["width"]["max"] = boxes[selected_box].features["R"]["width"]["max"];
                    box.features["R"]["height"]["min"] = boxes[selected_box].features["R"]["height"]["min"];
                    box.features["R"]["height"]["max"] = boxes[selected_box].features["R"]["height"]["max"];
                }
                catch(err)
                {}
                
                try{
                    box.features["T"]["regexp"] = boxes[selected_box].features["T"]["regexp"];
                    box.features["T"]["whitelist"] = boxes[selected_box].features["T"]["whitelist"];
                    box.features["T"]["dictionary"] = boxes[selected_box].features["T"]["dictionary"];
                }
                catch(err)
                {}
                
                //box.mouse = boxes[selected_box].mouse;
                
                box.mouse = {"type": null, "features": {"point": { "dx": 0, "dy": 0 }}};
                
                box.mouse["type"] = boxes[selected_box].mouse["type"];
                box.mouse["features"]["point"]["dx"] = boxes[selected_box].mouse["features"]["point"]["dx"];
                box.mouse["features"]["point"]["dy"] = boxes[selected_box].mouse["features"]["point"]["dy"];
                
                //box.keyboard = boxes[selected_box].keyboard;
                box.keyboard = {"string": "", "delays_ms": 100, "durations_ms": 100};
                box.keyboard["string"] = boxes[selected_box].keyboard["string"];
                box.keyboard["delays_ms"] = boxes[selected_box].keyboard["delays_ms"];
                box.keyboard["durations_ms"] = boxes[selected_box].keyboard["durations_ms"];


                boxes.push(box)

                if(box.group==0) rectManager.g0_elements_cnt+=1;

                if(box.group==1) rectManager.g1_elements_cnt+=1;

                if(box.group==2) rectManager.g2_elements_cnt+=1;


                var thumbnails = [];

                var boxes_g0 = [];
                var boxes_g1 = [];
                var boxes_g2 = [];
                
                for (var i=0; i<boxes.length; i++)
                {
                    if(boxes[i].group == 0) boxes_g0.push(boxes[i]);
                    
                    if(boxes[i].group == 1) boxes_g1.push(boxes[i]);
                    
                    if(boxes[i].group == 2) boxes_g2.push(boxes[i]);
                }
                
                boxes = [];
                
                boxes = boxes.concat(boxes_g0, boxes_g1, boxes_g2);
                
                                    
                 
                for (var i =0; i<boxes.length; i++)
                {
                    thumbnails.push(boxes[i].thumbnail);
                }
                
                
                
                rectManager.set_rectangles(boxes);
                //boxes = rectManager.get_rectangles();
                                    
                draw(rectManager.last_mouse_event);
                createTreeTable({"thumbnails":thumbnails, "screen": old_thumbnail_screen});
            }
            else if(id == "detect_as_img")
            {
                $("#td_bg_" + selected_box).text("I");
                boxes[selected_box].type = "I";
                update_detection_view();
            }
            else if(id == "detect_as_rect")
            {
                $("#td_bg_" + selected_box).text("R");
                boxes[selected_box].type = "R";
                build_rect_features(boxes[selected_box]);
                update_detection_view();
            }
            else if(id == "detect_as_text")
            {
                $("#td_bg_" + selected_box).text("T");
                boxes[selected_box].type = "T";
                update_detection_view();
            }
            else if(id == "set_as_main")
            {
                var group = boxes[selected_box].group;
                
                boxes[selected_box].is_main = true;
                boxes[selected_box].thumbnail["is_main"] = true;
                
                var b = boxes[selected_box];
                
                var main_index = null;
                
                for (var i =0; i<boxes.length; i++)
                {
                    if (boxes[i].group == group)
                    {
                        main_index = i;
                        boxes[i].is_main = false;
                        boxes[i].thumbnail["is_main"] = false;
                        break;
                    }
                }
                
                boxes[selected_box] = boxes[main_index];
                boxes[main_index] = b;
                
                
                var thumbnails = [];
                for (var i =0; i<boxes.length; i++)
                {
                    thumbnails.push(boxes[i].thumbnail);
                }
                
                draw(rectManager.last_mouse_event);
                createTreeTable({"thumbnails":thumbnails, "screen": old_thumbnail_screen});

            }
            else if(id == 'remove_comp')
            {
                var group = boxes[selected_box].group;
                
                var new_boxes = [];
                var thumbnails = []

                
                for (var i=0; i<boxes.length; i++)
                {
                    if(i != selected_box)
                    {
                        new_boxes.push(boxes[i]);
                    }
                }
                
                if(group==0) rectManager.g0_elements_cnt-=1;

                if(group==1) rectManager.g1_elements_cnt-=1;

                if(group==2) rectManager.g2_elements_cnt-=1;
                
                boxes = new_boxes;
                
                var thumbnails = [];
                for (var i =0; i<boxes.length; i++)
                {
                    thumbnails.push(boxes[i].thumbnail);
                }
                
                rectManager.set_rectangles(boxes);
                
                draw(rectManager.last_mouse_event);
                createTreeTable({"thumbnails":thumbnails, "screen": old_thumbnail_screen});
            }
            else if(id == 'new_component')
            {
                rectManager.set_intent({"type":"capturing", "features":{}});
                
                if (selected_box == -1)
                {
                    //click on screen
                    
                    var group = 0;
                    
                    if (rectManager.g0_elements_cnt < 5) group = 0;
                    
                    else if (rectManager.g1_elements_cnt < 5) group = 1;
                    
                    else if (rectManager.g2_elements_cnt < 5) group = 2;
                     
                    rectManager.set_group(group);
                }
                else
                {
                    //click on component
                    rectManager.set_group(boxes[selected_box].group);
                }
                
                dhxWins.forEachWindow(function(win){win.close();});
            }
            else if (id == "rem_all")
            {
                var r = confirm("Are you sure?");
                if (r == false) return;
                boxes = [];
                

                rectManager.main_g0_created = false;

                rectManager.main_g1_created = false;

                rectManager.main_g2_created = false;

                rectManager.g0_elements_cnt = 0;

                rectManager.g1_elements_cnt = 0;

                rectManager.g2_elements_cnt = 0;
                
                rectManager.set_rectangles(boxes);
                
                draw(rectManager.last_mouse_event);
                createTreeTable({"thumbnails":[], "screen": old_thumbnail_screen});
            }
        }
        
        function appear_click(){
            detection["type"] = "appear";
        }
        
        function appear_disappear_click(){
            detection["type"] = "appear+disappear";
        }
        
        function disappear_click(){
            detection["type"] = "disappear";
        }
        
        function break_click(element){
            if (element.checked) detection["break"] = true;
            
            else detection["break"] = false;
        }
        
        function timeout_s_change(element){
        
            detection["timeout_s"] = element.valueAsNumber;
        
        }
        
        function change_object_type(td_id){
            console.log(td_id);
            
            var text = $("#" + td_id).text();
            
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            
            if (text == "I")
            {
                $("#" + td_id).text("R");
                rect.type = "R";
                build_rect_features(rect);
                //$('#text_options').hide(); $('#image_options').hide(); $('#rect_options').show();
            }
            else if (text == "R"){
                $("#" + td_id).text("T");
                rect.type = "T";
                //$('#image_options').hide(); $('#rect_options').hide(); $('#text_options').show();
            }
            else if (text == "T"){
                $("#" + td_id).text("I");
                rect.type = "I";
                //$('#text_options').hide(); $('#rect_options').hide(); $('#image_options').show();
            }
            
            update_detection_view();

        }
        
        function change_object_type_by_button(type)
        {
            if(type == "I")
            {
                $("#td_bg_" + selected_box).text("I");
                boxes[selected_box].type = "I";
                update_detection_view();
            }
            else if(type == "R")
            {
                $("#td_bg_" + selected_box).text("R");
                boxes[selected_box].type = "R";
                build_rect_features(boxes[selected_box]);
                update_detection_view();
            }
            else if(type == "T")
            {
                $("#td_bg_" + selected_box).text("T");
                boxes[selected_box].type = "T";
                update_detection_view();
            }
        }
        
        function add_object_button()
        {
            rectManager.set_intent({"type":"capturing", "features":{}});
            
            if (selected_box == -1)
            {
                //click on screen
                
                var group = 0;
                
                if (rectManager.g0_elements_cnt < 5) group = 0;
                
                else if (rectManager.g1_elements_cnt < 5) group = 1;
                
                else if (rectManager.g2_elements_cnt < 5) group = 2;
                 
                rectManager.set_group(group);
            }
            else
            {
                //click on component
                rectManager.set_group(boxes[selected_box].group);
            }
            
            dhxWins.forEachWindow(function(win){win.close();});
        }
        
        function build_rect_features(rect)
        {
            var rect_features = rect.features["R"];
        
            if(rect.w >= rect.h * 8 && rect.h >= 15 && rect.h <= 50)  //INPUT BOX
            {
                if (rect.w >= 1200)
                {
                    rect_features["width"] = {"min":rect.w - 800, "max":rect.w + 900};
                    rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
                }
                else if (rect.w >= 700)
                {
                    rect_features["width"] = {"min":rect.w - 350, "max":rect.w + 800};
                    rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
                }
                else if (rect.w >= 300)
                {
                    rect_features["width"] = {"min":rect.w - 140, "max":rect.w + 500};
                    rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
                }
                else
                {
                    rect_features["width"] = {"min":rect.w - 10, "max":rect.w + 150};
                    rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
                }
            }
            else if (rect.w >= 120 && rect.h >= 120) //WINDOW
            {
                if (rect.w >= 1200)
                {
                    rect_features["width"] = {"min":rect.w - 700, "max":rect.w + 900};
                }
                else if (rect.w >= 700)
                {
                    rect_features["width"] = {"min":rect.w - 400, "max":rect.w + 850};
                }
                else if (rect.w >= 300)
                {
                    rect_features["width"] = {"min":rect.w - 350, "max":rect.w + 800};
                }
                else
                {
                    rect_features["width"] = {"min":rect.w - 80, "max":rect.w + 300};
                }
                
                if (rect.h >= 1200)
                {
                    rect_features["height"] = {"min":rect.h - 700, "max": rect.h + 900};
                }
                else if (rect.h >= 700)
                {
                    rect_features["height"] = {"min":rect.h - 400, "max": rect.h + 850};
                }
                else if (rect.h >= 300)
                {
                    rect_features["height"] = {"min":rect.h - 350, "max": rect.h + 800};
                }
                else
                {
                    rect_features["height"] = {"min":rect.h - 80, "max": rect.h + 300};
                }
                
            }
            else //BUTTON
            {
                var min_w = rect.w - 10;
                var min_h = rect.h - 10;
                
                if (min_w < 4) min_w = 4;
                
                if (min_h < 4) min_h = 4;
                
                rect_features["width"] = {"min":min_w, "max": rect.w + 10};
                rect_features["height"] = {"min":min_h, "max":rect.h + 10};
            }
        }
        
        function regexp_change()
        {
            //console.log(event.target.value)
            let value = event.target.value;
            
            //console.log(value);
            
            text_box = boxes[selected_box];
            var text_features = text_box.features["T"];
            text_features["regexp"] = value;
            
        }
        
        function interaction_change(element)
        {
            var interaction_type = element.value;
            // [(0, "None"), (1, "Move"), (2, "Click"), (3, "Scroll"), (4, "Hold"), (5, "Release")],
            
            $('#td_mouse_' + selected_box).empty();

            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_features = rect.mouse['features'];
            
            if (interaction_type == 0) //NONE
            {
                $("#mouse_set_point").hide();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                rect.mouse['type'] = null;
            }
            else if (interaction_type == 1) //MOVE
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                $('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px.png' />");
                
                rect.mouse['type'] = 'move';
                
            }
            else if (interaction_type == 2) //CLICK
            {
                
                $("#mouse_set_point").show();
                $("#mouse_button_l").show();
                $("#mouse_button_r").show();
                $("#mouse_units").show();
                $("#mouse_delays").show();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                if (mouse_units >= 2)
                {
                    if(mouse_features['button'] == 'left')
                    {
                        $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4.png' />");
                    }
                    else if (mouse_features['button'] == 'right')
                    {
                        $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4_2.png' />");
                    }
                }
                else{
                    if(mouse_features['button'] == 'left')
                    {
                        $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px2.png' />");
                    }
                    else if(mouse_features['button'] == 'right')
                    {
                        $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px3.png' />");
                    }
                }

                
                rect.mouse['type'] = 'click';

            }
            else if (interaction_type == 3) //SCROLL
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").show();
                $("#mouse_delays").show();
                $("#mouse_direction").show();
                $("#mouse_pixels").hide();
                
                $('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px7.png' />");
                
                $('select[name="mouse_direction"] option[value=0]').prop('disabled',true);
                
                rect.mouse['type'] = 'scroll';
            }
            else if (interaction_type == 4) //HOLD
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                $('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px10.png' />");
                
                $('select[name="mouse_direction"] option[value=0]').prop('disabled',false);
                
                rect.mouse['type'] = 'hold';
                
            }
            else if (interaction_type == 5) //RELEASE
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").show();
                $("#mouse_pixels").show();
                
                $('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px12.png' />");
                
                $('select[name="mouse_direction"] option[value=0]').prop('disabled',false);
                
                rect.mouse['type'] = 'release';
            }
            
            update_interaction_view();
        }
        
        function update_detection_view()
        {
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var object_type = rect.type;
            
               
            if (object_type == "I")
            {
                $('#text_options').hide(); $('#rect_options').hide(); $('#image_options').show();
                
                var rect_features = rect.features["I"];
                
                if(rect_features["colors"] == true && rect_features["likelihood"] == 0.9)
                {
                    $('input[name="img_match_type"][value="match"]').prop("checked", true);
                }
                else if (rect_features["colors"] == true && rect_features["likelihood"] == 0.7)
                {
                    $('input[name="img_match_type"][value="color"]').prop("checked", true);
                }
                else if (rect_features["colors"] == false && rect_features["likelihood"] == 0.7)
                {
                    $('input[name="img_match_type"][value="shape"]').prop("checked", true);
                }
            }
            else if (object_type == "R"){
                $('#text_options').hide(); $('#image_options').hide(); $('#rect_options').show();
                
                var rect_features = rect.features["R"];
                
                var min_w = rect_features["width"]["min"];
                var max_w = rect_features["width"]["max"];

                var min_h = rect_features["height"]["min"];
                var max_h = rect_features["height"]["max"]; 
                
                var is_box = false;
                var is_window = false;
                var is_button = false;
                
                if ((min_w == rect.w - 800 && max_w == rect.w + 900 && min_h == rect.h - 8 && max_h == rect.h + 8) ||
                    (min_w == rect.w - 350 && max_w == rect.w + 800 && min_h == rect.h - 8 && max_h == rect.h + 8) ||
                    (min_w == rect.w - 140 && max_w == rect.w + 500 && min_h == rect.h - 8 && max_h == rect.h + 8) ||
                    (min_w == rect.w - 10 && max_w == rect.w + 150 && min_h == rect.h - 8 && max_h == rect.h + 8))
                {
                    is_box = true;
                }
                else if (((min_w == rect.w - 700 && max_w == rect.w + 900) ||
                    (min_w == rect.w - 400 && max_w == rect.w + 850) ||
                    (min_w == rect.w - 350 && max_w == rect.w + 800) ||
                    (min_w == rect.w - 80 && max_w == rect.w + 300)) &&
                    ((min_h == rect.h - 700 && max_h == rect.h + 900) ||
                    (min_h == rect.h - 400 && max_h == rect.h + 850) ||
                    (min_h == rect.h - 350 && max_h == rect.h + 800) ||
                    (min_h == rect.h - 80 && max_h == rect.h + 300)))
                {
                    is_window = true;
                }
                else
                {
                    is_button = true;
                }

                
                if (is_box == true)
                {
                    $('input[name="rect_match_type"][value="box"]').prop("checked", true);
                }
                else if(is_window == true)
                {
                    $('input[name="rect_match_type"][value="window"]').prop("checked", true);
                   
                }
                else
                {
                    $('input[name="rect_match_type"][value="button"]').prop("checked", true);
                }
                
            }
            else if (object_type == "T")
            {
                $('#image_options').hide(); $('#rect_options').hide(); $('#text_options').show();
                
                var rect_features = rect.features["T"];
                
                if(jQuery.isEmptyObject(rect_features))
                {
                    $('input[name="text_match_type"][value="detect"]').prop("checked", true);
                    rect_features["type"] = "detection";
                }
                else
                {
                    if (rect_features["type"] == "detection")
                    {
                        $('input[name="text_match_type"][value="detect"]').prop("checked", true);
                                                                
                        $('#input_box_regexp').val(rect_features["regexp"]);
                    }
                    else if (rect_features["type"] == "scraper")
                    {
                        $('input[name="text_match_type"][value="scrap"]').prop("checked", true);
                    }
                }

            }
            
            adjust_win_size();
        }
        
                
        function update_interaction_view()
        {
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            if (mouse_features['button'] == null || mouse_features['button'] == 'left')
            {
                $('input[name="mouse_button"][value="left"]').prop("checked", true);
                mouse_features['button'] = 'left';
            }
            else if(mouse_features['button'] == 'right')
            {
                $('input[name="mouse_button"][value="right"]').prop("checked", true);
            }
            
            if (mouse_features['amount'] == null)
            {
                $('input[name="mouse_units"]').val(1);
                mouse_features['amount'] = 1;
            }
            else
            {
                $('input[name="mouse_units"]').val(mouse_features['amount']);
            }
            
            
            if (mouse_features['delays_ms'] == null)
            {
                $('input[name="mouse_delay"]').val(100);
                mouse_features['delays_ms'] = 100;
            }
            else
            {
                $('input[name="mouse_delay"]').val(mouse_features['delays_ms']);
            }
            
            if (mouse_features['pixels'] == null)
            {
                $('input[name="mouse_pixels"]').val(100);
                mouse_features['pixels'] = 100;
            }
            else
            {
                $('input[name="mouse_pixels"]').val(mouse_features['pixels']);
            }
            
                        
            if (mouse_features['direction'] == null && mouse_type == 'scroll')
            {
                $('select[name="mouse_direction"]').val(2); //down
                mouse_features['direction'] = 'down';
                $("#mouse_pixels").hide();
            }
            else if (mouse_features['direction'] == null && mouse_type == 'release')
            {
                $('select[name="mouse_direction"]').val(0); //none
                mouse_features['direction']  = 'none';
                $("#mouse_pixels").hide();
            }
            else if (mouse_features['direction'] != null && mouse_type == 'scroll')
            {
                if(mouse_features['direction'] == 'up')
                {
                    $('select[name="mouse_direction"]').val(1);
                }
                else if(mouse_features['direction'] == 'down')
                {
                    $('select[name="mouse_direction"]').val(2);
                }
                else if(mouse_features['direction'] == 'left')
                {
                    $('select[name="mouse_direction"]').val(3);
                }
                else if(mouse_features['direction'] == 'right')
                {
                    $('select[name="mouse_direction"]').val(4);
                }
                
                $("#mouse_pixels").hide();
            }
            else if (mouse_features['direction'] != null && mouse_type == 'release')
            {
                if(mouse_features['direction'] == 'none')
                {
                    $('select[name="mouse_direction"]').val(0);
                }
                else if(mouse_features['direction'] == 'up')
                {
                    $('select[name="mouse_direction"]').val(1);
                }
                else if(mouse_features['direction'] == 'down')
                {
                    $('select[name="mouse_direction"]').val(2);
                }
                else if(mouse_features['direction'] == 'left')
                {
                    $('select[name="mouse_direction"]').val(3);
                }
                else if(mouse_features['direction'] == 'right')
                {
                    $('select[name="mouse_direction"]').val(4);
                }
                
                $("#mouse_pixels").show();
            }
            
            if (mouse_features['amount'] <2)
            {
                $("#mouse_delays").hide();
            }
            else{
                $("#mouse_delays").show();
            }
            
            //console.log(element.value);
            if (rect.keyboard['string'] != null && rect.keyboard['string'] != "" )
            {
                $('input[name="interaction_string"]').val(rect.keyboard['string']);
            }
            else
            {
                $('input[name="interaction_string"]').val("");
            }
                

            adjust_win_size();
            
        }
        
        function mouse_delay_change(element)
        {
            var mouse_delay = element.valueAsNumber;
            
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            mouse_features['delays_ms'] = mouse_delay;
        }
        
        function mouse_units_change(element)
        {
            var mouse_units = element.valueAsNumber;
            
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            mouse_features['amount'] = mouse_units;
            
            if (mouse_units >= 2)
            {
                if(mouse_features['button'] == 'left' && rect.mouse['type'] == 'click')
                {
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4.png' />");
                }
                else if (mouse_features['button'] == 'right' && rect.mouse['type'] == 'click')
                {
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4_2.png' />");
                }
                
                $("#mouse_delays").show();
            }
            else{
                if(mouse_features['button'] == 'left' && rect.mouse['type'] == 'click')
                {
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px2.png' />");
                }
                else if(mouse_features['button'] == 'right' && rect.mouse['type'] == 'click')
                {
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px3.png' />");
                }
                
                $("#mouse_delays").hide();
            }
        }
        
        function mouse_pixels_change(element)
        {
            var mouse_pixels = element.valueAsNumber;
            
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            mouse_features['pixels'] = mouse_pixels;
        }
        
        function mouse_direction_change(element)
        {
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            if (element.value == 0)
            {
                $("#mouse_pixels").hide();
            }
            else if (mouse_type != 'scroll') {
                $("#mouse_pixels").show();
            }
            
            if (mouse_type == 'scroll')
            {
                if (element.value == 0)
                {
                    $('select[name="mouse_direction"]').val(2);
                    mouse_features['direction'] = 'down';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px7.png' />");
                }
                else if (element.value == 1)
                {
                    mouse_features['direction'] = 'up';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px6.png' />");
                }
                else if (element.value == 2)
                {
                    mouse_features['direction'] = 'down';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px7.png' />");
                }
                else if (element.value == 3)
                {
                    mouse_features['direction'] = 'left';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px8.png' />");
                }
                else if (element.value == 4)
                {
                    mouse_features['direction'] = 'right';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px9.png' />");
                }
                
            }
            
            else if (mouse_type == 'release')
            {
                if (element.value == 0)
                {
                    mouse_features['direction'] = 'none';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px12.png' />");
                }
                else if (element.value == 1)
                {
                    mouse_features['direction'] = 'up';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px13.png' />");
                }
                else if (element.value == 2)
                {
                    mouse_features['direction'] = 'down';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px14.png' />");
                }
                else if (element.value == 3)
                {
                    mouse_features['direction'] = 'left';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px15.png' />");
                }
                else if (element.value == 4)
                {
                    mouse_features['direction'] = 'right';
                    $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px16.png' />");
                }
                
            }
        }
        
        function image_type_match_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['I'];
            
            rect_features["colors"] = true;
            rect_features["likelihood"] = 0.9;
        
        }
        
        function image_type_color_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['I'];
            
            rect_features["colors"] = true;
            rect_features["likelihood"] = 0.7;
        
        }
        
        function image_type_shape_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['I'];
            
            rect_features["colors"] = false;
            rect_features["likelihood"] = 0.7;

        
        }
        
        function rect_type_box_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['R'];
            
            if (rect.w >= 1200)
            {
                rect_features["width"] = {"min":rect.w - 800, "max":rect.w + 900};
                rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
            }
            else if (rect.w >= 700)
            {
                rect_features["width"] = {"min":rect.w - 350, "max":rect.w + 800};
                rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
            }
            else if (rect.w >= 300)
            {
                rect_features["width"] = {"min":rect.w - 140, "max":rect.w + 500};
                rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
            }
            else
            {
                rect_features["width"] = {"min":rect.w - 10, "max":rect.w + 150};
                rect_features["height"] = {"min":rect.h - 8, "max":rect.h + 8};
            }

        
        }
        
        function rect_type_window_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['R'];
            
            if (rect.w >= 1200)
            {
                rect_features["width"] = {"min":rect.w - 700, "max":rect.w + 900};
            }
            else if (rect.w >= 700)
            {
                rect_features["width"] = {"min":rect.w - 400, "max":rect.w + 850};
            }
            else if (rect.w >= 300)
            {
                rect_features["width"] = {"min":rect.w - 350, "max":rect.w + 800};
            }
            else
            {
                rect_features["width"] = {"min":rect.w - 80, "max":rect.w + 300};
            }
            
            if (rect.h >= 1200)
            {
                rect_features["height"] = {"min":rect.h - 700, "max": rect.h + 900};
            }
            else if (rect.h >= 700)
            {
                rect_features["height"] = {"min":rect.h - 400, "max": rect.h + 850};
            }
            else if (rect.h >= 300)
            {
                rect_features["height"] = {"min":rect.h - 350, "max": rect.h + 800};
            }
            else
            {
                rect_features["height"] = {"min":rect.h - 80, "max": rect.h + 300};
            }
        }
        
        function rect_type_button_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['R'];
            
            var min_w = rect.w - 10;
            var min_h = rect.h - 10;
            
            if (min_w < 4) min_w = 4;
            
            if (min_h < 4) min_h = 4;
            
            rect_features["width"] = {"min":min_w, "max": rect.w + 10};
            rect_features["height"] = {"min":min_h, "max":rect.h + 10};
        }
        
        
        function text_type_detect_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['T'];
            
            rect_features["type"] = "detection";

        
        }
        
        function text_type_scrap_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var rect_features = rect.features['T'];
            
            rect_features["type"] = "scraper";

        
        }
        
        function mouse_set_point_click(element){
            if(element.outerText === "{{text.label_set_point}}")
            {
                rectManager.set_intent({"type":"set_interaction_point", "features":{"index": selected_box}});
                rectManager.set_group(boxes[selected_box].group);
                dhxWins.forEachWindow(function(win){win.close();});

            }
            else
            {           
                var interaction_dict = {
                    "dx": 0,
                    "dy": 0,
                };
                      
                boxes[selected_box].mouse["features"]["point"] = interaction_dict;
                rectManager.set_rectangles(boxes);
                draw(rectManager.last_mouse_event);
                $("#" + element.id).text("{{text.label_set_point}}");
            }
            
            

        }
        
        function mouse_left_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            mouse_features['button'] = 'left';
            
            //$('#td_mouse_' + selected_box).empty();
            if (mouse_features['amount'] >= 2)
            {

                $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4.png' />");
               
            }
            else{
                $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px2.png' />");

            }
        
        }
        
        function mouse_right_click(){
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            var mouse_type = rect.mouse['type'];
            var mouse_features = rect.mouse['features'];
            
            mouse_features['button'] = 'right';
            
            //$('#td_mouse_' + selected_box).empty();
            if (mouse_features['amount'] >= 2)
            {
                $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4_2.png' />");
            }
            else{

                $('#td_mouse_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px3.png' />");
            }
        
        }
        
        function interaction_string_change(element)
        {
            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            
            
            //console.log(element.value);
            if (element.value != null && element.value != "" )
            {
                if (element.value.match("\{arg(.*)\}"))
                {
                    $('#td_keyboard_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Keyboard_32px6.png' />");
                }
                else
                {
                    $('#td_keyboard_' + selected_box).html("<img src='static/img/icons/1x/190123_Alyvix_Keyboard_32px.png' />");
                }
                
            }
            else
            {
                $('#td_keyboard_' + selected_box).empty();
            }
            
            rect.keyboard['string'] = element.value;

        }
        
        function on_table_index_changed()
        {
            // [(0, "None"), (1, "Move"), (2, "Click"), (3, "Scroll"), (4, "Hold"), (5, "Release")],
            
            //$('#td_mouse_' + selected_box).empty();

            var rects = rectManager.get_rectangles();
            var rect = rects[selected_box];
            
            var interaction_type = rect.mouse['type'];
            
            var mouse_features = rect.mouse['features'];
            var mouse_point = mouse_features["point"];
            
            if(mouse_point["dx"] != 0 || mouse_point["dy"] != 0)
            {
                $("#set_point_button").text("{{text.label_reset_point}}");
            }
            else
            {
                $("#set_point_button").text("{{text.label_set_point}}");
            }
            
            if (interaction_type == 'none' || interaction_type == null) //NONE
            {
                $("#mouse_set_point").hide();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                $('select[name="mouse_interaction_type"]').val(0);

            }
            else if (interaction_type == 'move') //MOVE
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                //$('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px.png' />");
                $('select[name="mouse_interaction_type"]').val(1);

                
            }
            else if (interaction_type == 'click') //CLICK
            {
                
                $("#mouse_set_point").show();
                $("#mouse_button_l").show();
                $("#mouse_button_r").show();
                $("#mouse_units").show();
                $("#mouse_delays").show();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                //$('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px2.png' />");
                $('select[name="mouse_interaction_type"]').val(2);


            }
            else if (interaction_type == 'scroll') //SCROLL
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").show();
                $("#mouse_delays").show();
                $("#mouse_direction").show();
                $("#mouse_pixels").hide();
                
                //$('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px7.png' />");
                $('select[name="mouse_interaction_type"]').val(3);
                $('select[name="mouse_direction"] option[value=0]').prop('disabled',true);

            }
            else if (interaction_type == 'hold') //HOLD
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").hide();
                $("#mouse_pixels").hide();
                
                //$('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px10.png' />");
                $('select[name="mouse_interaction_type"]').val(4);
                $('select[name="mouse_direction"] option[value=0]').prop('disabled',false);

                
            }
            else if (interaction_type == 'release') //RELEASE
            {
                $("#mouse_set_point").show();
                $("#mouse_button_l").hide();
                $("#mouse_button_r").hide();
                $("#mouse_units").hide();
                $("#mouse_delays").hide();
                $("#mouse_direction").show();
                $("#mouse_pixels").show();
                
                //$('#td_mouse_' + selected_box).append("<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px12.png' />");
                $('select[name="mouse_interaction_type"]').val(5);
                $('select[name="mouse_direction"] option[value=0]').prop('disabled',false);

            }
            
            update_detection_view();
            update_interaction_view();
        }

        

        
        function drawOnThumbnails(canvas_id, group, x, y, w, h, image_w, image_h)
        {
            var background_color = "";
            var border_color = "";
            
            if (group == 0)
            {
                background_color = "#ff00ff";
                border_color = "#ff0000";
            }
            else if (group == 1)
            {
                background_color = "#00bc00";
                border_color = "#009500";
            }
            else if (group == 2)
            {
                background_color = "#0072ff";
                border_color = "#0000ff";
            }
            
            var canvas_thumbnail = document.getElementById(canvas_id);
            var ctx_thumbnail = canvas_thumbnail.getContext('2d');
            
            canvas_thumbnail.setAttribute('width', image_w*dpi);
            canvas_thumbnail.setAttribute('height', image_h*dpi);
            
            ctx_thumbnail.scale(dpi, dpi);
            ctx_thumbnail.translate(0.5, 0.5);
            ctx_thumbnail.lineWidth = 1;
            ctx_thumbnail.strokeStyle = border_color;
            ctx_thumbnail.strokeRect(x, y, w, h);
            

            
        }
        
        function createTreeTable(dat){
        
            
        
            $('#add_irt_button').hide();
            $('#detection_option').hide();
            $('#interaction_mouse_option').hide();
            $('#interaction_keyboard_option').hide();
            $("#tt_row").empty();
            
                    
            var thumbnails_array = dat['thumbnails'];
            
            for (var i = 0; i < thumbnails_array.length; i++){
                boxes[i].thumbnail = thumbnails_array[i];
            }
            
            if(detection["type"] == "appear")  $('input[name="find_type"][value="appear"]').prop("checked", true);
            
            else if( detection["type"] == "appear+disappear")  $('input[name="find_type"][value="appear_disappear"]').prop("checked", true);
            
            else if (detection["type"] == "disappear") $('input[name="find_type"][value="disappear"]').prop("checked", true);
            
            //detection["type"]
        
            $('input[name="timeout_s"]').val(detection["timeout_s"]);
            
            if (detection["break"] == true) $('input[name="break"]').prop("checked", true);
            else $('input[name="break"]').prop("checked", false);
            
            var screen_dict = dat['screen'];
            
            old_thumbnail_screen = screen_dict;
            
            var html_string = '';
            

            var image = screen_dict['image'];
            var image_w = screen_dict['image_w'];
            var image_h = screen_dict['image_h'];

            var background_color_screen = "#808080";
            var border_color_screen = "#808080";
            
            html_string += "<div id='container_table'>";
            html_string += "<table class='treetable' style=\"border:none;\" border='0' cellspacing=\"0\" cellpadding=\"0\">";
            html_string += "<tr id='thumbnail_row_screen'><td class='container' style='height:"+ (image_h + 2) +"px;' >";
            html_string += "<div class='thumbnail'>";
            html_string += "<div id='thumbnail_screen' class='thumbnail-container' style=\"width:" +  (15 + image_w) + "px; height: " + image_h + "px; font-size:15px; font-weight: bold; border-color: " + border_color_screen + "; border-style: solid; border-width: 1px;\">" ;
            html_string += "<table style=\"width:" + (15 + image_w) + "px; height:"+ image_h +"px; border:none;\" cellspacing=\"0\" cellpadding=\"0\">" ;
            html_string += "<tr>" ;
            html_string += "<td style=\"width:15px; color: white; background-color: " + background_color_screen + "; padding: 0; margin: 0; font-size:12px; vertical-align: middle; text-align: center;\">S</td>" ;
            html_string += "<td style=\"width:" + image_w + "px; padding: 0; margin: 0;font-size:0;\"><canvas id=\"thumbnail_canvas_screen\" class='canvas-container' style=\"background-image: url('data:image/png;base64," + image + "'); width:" + image_w + "px; height:" + image_h +"px;\"></canvas></td>" ;
            html_string += "</tr>" ;
            html_string += "</table>"; 
            html_string += "</div>" ;
            html_string += "</div>";
            html_string += "</td>";
            html_string += "<td></td>";
            html_string += "<td></td>";
            html_string += "</tr>";
            
            //$("#thumbnailsDiv").append(html_string);

            var tail_z_index = 99;
            
            var main_index = 0;
            
            var cnt_sub_level_1 = 0;
            
            var object_type = "I";
            
            //for (var i = 0; i < thumbnails_array.length; i++){
            for (var i = 0; i < boxes.length; i++){
            
                object_type = boxes[i].type;
            
                var thumbnail = boxes[i].thumbnail;
                
                var image = thumbnail['image'];
                var image_w = thumbnail['image_w'];
                var image_h = thumbnail['image_h'];
                var x = thumbnail['x'];
                var y = thumbnail['y'];
                var w = thumbnail['w'];
                var h = thumbnail['h'];
                var group = thumbnail['group'];
                var is_main = thumbnail['is_main'];
                
                var mouse_type = boxes[i].mouse['type'];
                var mouse_features = boxes[i].mouse['features'];
                
                var keyboard_string = boxes[i].keyboard['string'];
                
                //var box_features = boxes[i].features["I"];
                //box_features["colors"] = true;
                //box_features["likelihood"] = 0.9;
                
                
                
                var background_color = "";
                var border_color = "";
                
                if (group == 0)
                {
                    background_color = "#ff00ff";
                    border_color = "#ff0000";
                }
                else if (group == 1)
                {
                    background_color = "#00bc00";
                    border_color = "#009500";

                }
                else if (group == 2)
                {
                    background_color = "#0072ff";
                    border_color = "#0000ff";
                }

                
                var left = 0;
                var tail_height = 0;
                var tail_width = image_w + 15;
                
                var str_main_class = "";
                var str_row_main_class = "";
                
                if (is_main == true)
                {
                    left = 15 + image_w;
                    main_index = i;
                    
                    tail_height = (i+1)*(image_h + 2 + 8);
                    
                    str_main_class = "is-main";
                    str_row_main_class = "row-is-main";
                }
                else
                {
                    left = (15 + image_w)*2;
                    tail_height = (i - main_index)*(image_h + 2 + 8);
                    
                    cnt_sub_level_1 += 1;
                }

                //tail_height -= (image_h)/2
                
                mouse_icon = "";
                
                keyboard_icon = "";
                
                if (mouse_type == 'move')
                {
                    mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px.png' />";
                }
                else if (mouse_type == 'click')
                {
                    if (mouse_features['amount'] >= 2)
                    {
                        if(mouse_features['button'] == 'left')
                        {
                            mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4.png' />";
                        }
                        else
                        {
                            mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px4_2.png' />";
                        }
                    }
                    else{
                        if(mouse_features['button'] == 'left')
                        {
                            mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px2.png' />";
                        }
                        else
                        {
                            mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px3.png' />";
                        }
                    }
                    
                }
                else if (mouse_type == 'scroll')
                {
                    if(mouse_features['direction'] == 'up')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px6.png' />";
                    }
                    else if(mouse_features['direction'] == 'left')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px8.png' />";
                    }
                    else if(mouse_features['direction'] == 'right')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px9.png' />";
                    }
                    else
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px7.png' />";
                    }

                }
                else if (mouse_type == 'hold')
                {

                    mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px10.png' />";
                }
                else if (mouse_type == 'release')
                {
                    if(mouse_features['direction'] == 'up')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px13.png' />";
                    }
                    else if(mouse_features['direction'] == 'left')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px15.png' />";
                    }
                    else if(mouse_features['direction'] == 'right')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px16.png' />";
                    }
                    else if(mouse_features['direction'] == 'down')
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px14.png' />";
                    }
                    else
                    {
                        mouse_icon = "<img src='static/img/icons/1x/190123_Alyvix_Mouse_32px12.png' />";
                    }

                }
                
                if(keyboard_string != "" && keyboard_string != "none")
                {               
                    if (keyboard_string.match("\{arg(.*)\}"))
                    {
                        keyboard_icon = "<img src='static/img/icons/1x/190123_Alyvix_Keyboard_32px6.png' />";
                    }
                    else
                    {
                        keyboard_icon = "<img src='static/img/icons/1x/190123_Alyvix_Keyboard_32px.png' />";
                    }
                }
                
                html_string += "<tr id='thumbnail_row_" + i + "' class='row-group-" + group + " " + str_row_main_class + "'><td class='container' style='height:"+ (image_h + 2) +"px;'>" ;
                html_string += "<div class='thumbnail' style=' left: " + left + "px;'>";
                html_string += "<div id='tail_" + i + "' class='tail' style='pointer-events:none; z-index: " + tail_z_index + "; height: " + tail_height + "px; width: " + tail_width + "px; left: -" + parseInt((image_w + 15)/2) + "px;'></div>"; 
                
                html_string += "<div id='thumbnail_" + i + "' class='thumbnail-container group-" + group + " " + str_main_class + "' style=\"width:" +  (15 + image_w) + "px; height: " + image_h + "px; font-size:15px; font-weight: bold; border-color: " + border_color + "; border-style: solid; border-width: 1px;\" ondblclick=\"change_object_type('td_bg_" + i + "')\">" ;
                html_string += "<table style=\"width:" + (15 + image_w) + "px; height:"+ image_h +"px; border:none;\" cellspacing=\"0\" cellpadding=\"0\">" ;
                html_string += "<tr>" ;
                html_string += "<td id='td_bg_" + i + "' class='object_type' style=\"width:15px; color: white; background-color: " + background_color + "; padding: 0; margin: 0; font-size:12px; vertical-align: middle; text-align: center;\">" + object_type + "</td>" ;
                html_string += "<td id='td_canv_" + i + "' style=\"width:" + image_w + "px; padding: 0; margin: 0;font-size:0;\"><canvas id=\"thumbnail_canvas_" + i + "\" class='canvas-container' style=\"background-image: url('data:image/png;base64," + image + "'); width:" + image_w + "px; height:"+ image_h +"px;\"></canvas></td>" ;
                html_string += "</tr>" ;
                html_string += "</table>"; 
                html_string += "</div>" ;
                html_string += "</div>"
                html_string += "</td>" ;
                html_string += "<td id='td_mouse_" + i + "' class='mouse'>" + mouse_icon + "</td>";
                html_string += "<td id='td_keyboard_" + i + "' class='keyboard' >" + keyboard_icon + "</td>";
                html_string += "<script>drawOnThumbnails('thumbnail_canvas_" + i + "' , " + group + ", " + x + ", " + y + ", " + w + ", " + h + ", " + image_w + ", " + image_h + ");</" + "script>";
                html_string += "</tr>" ;
                /*html_string += "<script>";
                html_string += "canvas_thumb_" + parseInt(i) + " = document.getElementById('thumbnail_canvas_" + parseInt(i) + "');";
                html_string += "ctx_thumb_" + parseInt(i) + " = canvas_thumb_" + parseInt(i) + ".getContext('2d');";
                html_string += "canvas_thumb_" + parseInt(i) + ".setAttribute('width', " + parseInt(image_w)+ "*dpi);";
                html_string += "canvas_thumb_" + parseInt(i) + ".setAttribute('height'," + parseInt(image_h)+ "*dpi);";
                html_string += "ctx_thumb_" + parseInt(i) + ".scale(dpi, dpi);";
                html_string += "ctx_thumb_" + parseInt(i) + ".translate(0.5, 0.5);";
                html_string += "ctx.lineWidth = 1;";
                html_string += "ctx_thumb_" + parseInt(i) + ".strokeStyle = '" + border_color + "';";
                html_string += "ctx_thumb_" + parseInt(i) + ".strokeRect(" + parseInt(x) + ", " + parseInt(y) + ", "+ parseInt(w) + ", "+ parseInt(h) + ");";
                */
                
                //$("#thumbnailsDiv").append(html_string);
                
                //drawOnThumbnails("thumbnail_canvas_" + parseInt(i), group, x, y, w, h, image_w, image_h);
                //html_string += "<script>drawOnThumbnails('thumbnail_canvas_" + parseInt(i) + "' , " + parseInt(group) + ", " + parseInt(x) + ", " + parseInt(y) + ", " + parseInt(w) + ", " + parseInt(h) + ", " + parseInt(image_w) + ", " + parseInt(image_h) + ");</" + "script>";
                //$("#thumbnailsDiv").append("<script>drawOnThumbnails('thumbnail_canvas_" + parseInt(i) + "' , " + parseInt(group) + ", " + parseInt(x) + ", " + parseInt(y) + ", " + parseInt(w) + ", " + parseInt(h) + ", " + parseInt(image_w) + ", " + parseInt(image_h) + ");");
                tail_z_index -= 1;
            }
            
            html_string += "</table>";
            html_string += "</div>";
            
            html_string += "<script>$('table.treetable').on('click', 'tbody tr', function(e){";
            html_string += "    /*$(this).toggleClass('selected');*/";
            html_string += "    $('table.treetable tr').removeClass('selected');";
            html_string += "    $(this).addClass('selected');";
            html_string += "    if($(this).attr('id') != 'thumbnail_row_screen' && $(this).attr('id') != null){";
            html_string += "        console.log(\"row selected!!!\");";
            html_string += "        console.log($(this));";
            html_string += "        var obj_type = $(this).find('td.object_type');";
            html_string += "        console.log(obj_type.attr('id'));";
            html_string += "        console.log(obj_type.text());";
            html_string += "        selected_box = parseInt(obj_type.attr('id').replace('td_bg_',''));";
            html_string += "        if (obj_type.text() == 'I') { $('#text_options').hide(); $('#rect_options').hide(); $('#image_options').show();}";
            html_string += "        else if (obj_type.text() == 'R') { $('#text_options').hide(); $('#image_options').hide(); $('#rect_options').show();}";
            html_string += "        else if (obj_type.text() == 'T') { $('#image_options').hide(); $('#rect_options').hide(); $('#text_options').show();}";
            html_string += "        $('#add_irt_button').show();";
            html_string += "        $('#detection_option').show();";
            html_string += "        $('#interaction_mouse_option').show();";
            html_string += "        $('#interaction_keyboard_option').show();";
            html_string += "        on_table_index_changed();";
            html_string += "        adjust_win_size();";
            html_string += "    }";
            html_string += "    else{";
            html_string += "        selected_box = -1;";
            html_string += "        $('#add_irt_button').hide();";
            html_string += "        $('#detection_option').hide();";
            html_string += "        $('#interaction_mouse_option').hide();";
            html_string += "        $('#interaction_keyboard_option').hide();";
            html_string += "        adjust_win_size();";
            html_string += "    }});";
            
            html_string += "$('table.treetable').on('contextmenu', 'tbody tr', function(e){";
            html_string += "    /*$(this).toggleClass('selected');*/";
            html_string += "    $('table.treetable tr').removeClass('selected');";
            html_string += "    $(this).addClass('selected');";
            html_string += "    if($(this).attr('id') != 'thumbnail_row_screen' && $(this).attr('id') != null){";
            html_string += "        console.log(\"row selected!!!\");";
            html_string += "        console.log($(this));";
            html_string += "        var obj_type = $(this).find('td.object_type');";
            html_string += "        console.log(obj_type.attr('id'));";
            html_string += "        console.log(obj_type.text());";
            html_string += "        selected_box = parseInt(obj_type.attr('id').replace('td_bg_',''));";
            html_string += "        if (obj_type.text() == 'I') { $('#text_options').hide(); $('#rect_options').hide(); $('#image_options').show();}";
            html_string += "        else if (obj_type.text() == 'R') { $('#text_options').hide(); $('#image_options').hide(); $('#rect_options').show();}";
            html_string += "        else if (obj_type.text() == 'T') { $('#image_options').hide(); $('#rect_options').hide(); $('#text_options').show();}";
            html_string += "        $('#add_irt_button').show();";
            html_string += "        $('#detection_option').show();";
            html_string += "        $('#interaction_mouse_option').show();";
            html_string += "        $('#interaction_keyboard_option').show();";
            html_string += "        on_table_index_changed();";
            html_string += "        update_context_menu();";
            html_string += "        adjust_win_size();";
            html_string += "    }";
            html_string += "    else if($(this).attr('id') == 'thumbnail_row_screen') {";
            html_string += "        console.log(\"row selected!!!\");";
            html_string += "        console.log($(this));";
            html_string += "        selected_box = -1;";
            html_string += "        $('#add_irt_button').hide();";
            html_string += "        $('#detection_option').hide();";
            html_string += "        $('#interaction_mouse_option').hide();";
            html_string += "        $('#interaction_keyboard_option').hide();";
            html_string += "        update_context_menu_screen();";
            html_string += "        adjust_win_size();";
            html_string += "    }});";
            
            
            html_string += "</" + "script>";
        
            $("#tt_row").append(html_string);
            
            var td_container_width = 300;
            if(cnt_sub_level_1 == 0) td_container_width = (53+15+2) * 2;
            else  td_container_width = (53+15+2) * 3;
            
            var container = $("#container_table table td.container").css('width', td_container_width);
            
            ttMenu = new dhtmlXMenuObject({ parent:"container_table", image_path:"codebase/imgs/", context: true, auto_hide: false, auto_open: false,
           items:[ ] });
           
           ttMenu.attachEvent("onClick", function(id, zoneId, cas){
                context_menu_event(id);
            });
            
            var original_placeholder = null;
            
            $('table tbody .treetable').sortable({
                items: 'tr:not(tr:first-child)',
                connectWith: 'table',
                cursor: 'move',
                delay: 150,
                revert: 0,
                change: function(e, ui){

                    //salviamo l'html del placeholder, cioè lo spazio tra una riga e l'altra durante il sorting
                    if(original_placeholder == null) original_placeholder = ui.placeholder.html();
                    
                    var screen_dict = {};
                    
                    sorting_rows_dict = [];
                    
                    //sorting_t_id contiene l'id dell'helper, cioè l'oggetto che rappresenta l'elemento trascinato
                    var sorting_t_id = $(ui.item).attr("id");
                    sorting_t_id = sorting_t_id.replace("thumbnail_row_","");
                    sorting_t_id = "thumbnail_" + sorting_t_id;
                    
                    //recuperiamo la coordinata y dell'helper
                    var sorting_tt_y = curr_mouse_y; //findPosY(document.getElementById('sorting_tt').getBoundingClientRect());
                    console.log("sorting y: " + sorting_tt_y);
                    var sorting_tt_main = false;
                    var sorting_tt_group = null;
                    
                    var classes = $("#" + sorting_t_id).attr('class').split(/\s+/);    
    
                    for (var i=0; i< classes.length; i++){
                    
                        if(classes[i].includes("group"))
                        {
                            //recuperiamo il gruppo di appartenenza dell'helper
                            sorting_tt_group = classes[i];
                        }
                    
                    }
                    
                    //verifichiamo se l'oggetto trascinato è un main
                    if ($(ui.item).hasClass('row-is-main')) sorting_tt_main = true;
                    

                    var thumbnail_array = $(".thumbnail-container:not(#thumbnail_screen, .sorting-container, .sub-of-sorting-main)").map(function() {

                        return this;
                    
                    }).get();
                    
                    var screen_thumb =  $("#thumbnail_screen");
                    var screen_thumb_y = findPosY(document.getElementById('thumbnail_screen').getBoundingClientRect());
                    screen_dict = {"y":screen_thumb_y, "id": "thumbnail_screen", "h": screen_thumb.height()};
                                    
                    //thumbnail_screen_y;
                    
                    
                    for (var i = 0; i<thumbnail_array.length; i++ )
                    {
                        var t_id = $(thumbnail_array[i]).attr("id");
                        var is_main = false;
                        
                        if (t_id != sorting_t_id){
                            
                            var thumb_index = parseInt(t_id.replace("thumbnail_", ""));
                            
                            
                            var current_group = null;
                            

                            var thumbnail_y = findPosY(document.getElementById('thumbnail_' + thumb_index).getBoundingClientRect());
                            
                            var classes = $(thumbnail_array[i]).attr('class').split(/\s+/);
                            var group_name = null;
          
                            for (var j=0; j< classes.length; j++){
                            
                                if(classes[j].includes("group"))
                                {
                                    group_name = classes[j];
                                }
                                
                                if(classes[j].includes("main"))
                                {
                                    is_main = true;
                                }
                            
                            }
                            
                            var is_last_sub = false;
                            if (i+1 >= thumbnail_array.length){ 
                                                                
                                is_last_sub = true;
                            }
                            else
                            {
                                var classes = $(thumbnail_array[i+1]).attr('class').split(/\s+/);
                                var next_group_name = null;
              
                                for (var j=0; j< classes.length; j++){
                                
                                    if(classes[j].includes("group"))
                                    {
                                        next_group_name = classes[j];
                                    }
                                }
                                
                                if (group_name != next_group_name)
                                {
                                    is_last_sub = true;
                                }
                                
                            }
                            
                            
                            //if(t_id == )
                            var dictz = {"y":thumbnail_y, "group":group_name, "id": t_id, "h": $(thumbnail_array[i]).height(), "is_main": is_main, "is_last_sub": is_last_sub};
                            
                            sorting_rows_dict.push(dictz);
                        }
                    }
                    
                    /**/
                    
                    var sorting_is_valid = false;
                    
                    //se l'elemento che stiamo trascinando è un main...
                    if (sorting_tt_main == true)
                    {
                        for (var i=0; i<sorting_rows_dict.length; i++)
                        {
                            if (i+1 >= sorting_rows_dict.length ) //non posso controllare la riga corrente e la successiva, sono nell'ultimo gruppo
                            {
                                //ci assicuriamo che l'elemento trascinato sia sotto l'ultimo elemento
                                if( sorting_tt_y > sorting_rows_dict[i]["y"] + sorting_rows_dict[i]["h"] - 30 && sorting_rows_dict[i]["is_last_sub"] == true) sorting_is_valid = true;
                            }
                            
                            else{ //in questo caso siamo nell'ultimo gruppo

                                //ci assicuriamo che l'elemento si trovi sotto l'ultimo elemento di un gruppo e prima del primo elemento del gruppo successivo
                                if( sorting_tt_y > sorting_rows_dict[i]["y"] + sorting_rows_dict[i]["h"] - 30 && sorting_rows_dict[i]["is_last_sub"] == true && sorting_tt_y < sorting_rows_dict[i+1]["y"] + 30 ) // && sorting_rows_dict[i]["is_main"] == false)
                                {
                                    sorting_is_valid = true;
                                }
                            }

                        }
                        
                        //verifichiamo anche se l'elemento trascinato sia sotto lo screen
                        if( sorting_tt_y > screen_dict["y"] + screen_dict["h"] - 30 && sorting_tt_y < sorting_rows_dict[0]["y"] + 30 ) sorting_is_valid = true;
                    }
                    else
                    {   //in questo caso stiamo trascinando un sub
                        for (var i=0; i<sorting_rows_dict.length; i++)
                        {
                            //assicuriamoci che sia tracinato solo all'interno del suo gruppo
                            if( sorting_tt_y > sorting_rows_dict[i]["y"] - 30 && sorting_tt_y < sorting_rows_dict[i]["y"] + sorting_rows_dict[i]["h"] + 30 && sorting_rows_dict[i]["group"] == sorting_tt_group && sorting_rows_dict[i]["is_main"] == false)
                            {
                                if (i==0)
                                {
                                    var aaa = 0;
                                }
                                
                                sorting_is_valid = true;
                            }
                        }
                        
                    }
                    
                    original_placeholder = original_placeholder.replace(/<td/ig, "<td class='border_bottom'");
                    
                    if (sorting_is_valid == false) ui.placeholder.html("<div></div>");
                    else ui.placeholder.html(original_placeholder);
                
                
                
                    
                    //console.log(ui);
                    //console.log(e);
                    
                    redraw_treetail();
             
                },
                start: function(e, ui){

                    //per ogni thumbnail che stiamo spostando, disegnamo il rettangolo sul suo canvas (poiché quando trasciniamo un elemento il suo canvas viene resettato)
                    for (var i=0; i< canvas_sorting_ids.length; i++){
                        
                            var index = parseInt(canvas_sorting_ids[i].replace("_sorting","").replace("thumbnail_canvas_",""));
                            
                            var thumbnail = thumbnails_array[index];

                            var image = thumbnail['image'];
                            var image_w = thumbnail['image_w'];
                            var image_h = thumbnail['image_h'];
                            var x = thumbnail['x'];
                            var y = thumbnail['y'];
                            var w = thumbnail['w'];
                            var h = thumbnail['h'];
                            var group = thumbnail['group'];
                            var is_main = thumbnail['is_main'];
                        
                            drawOnThumbnails(canvas_sorting_ids[i], group, x, y, w, h, image_w, image_h);
                    }
                    
                    redraw_treetail();

                },
                stop: function(e, ui){
                
                    $(".row-to-remove").remove(); //rimuoviamo tutte le righe che erano invisibili
                
                    var html_after = "";
                    
                    //se stavo trascinando/sortando un main allora rows_html contine il codice
                    //html delle righe dei suoi sub
                    for (var i=0; i< rows_html.length; i++)
                    {
                        html_after += rows_html[i];
                    }
                    
                    var group_name = null;
                    
                    var row_id = $(ui.item[0]).attr('id');
                                        
                    var classes = $(ui.item[0]).attr('class').split(/\s+/);
                    
                    
                    for (var i=0; i< classes.length; i++){
                    
                        if(classes[i].includes("group"))
                        {
                            group_name = classes[i];
                        }
                    
                    }
                    
                    if (html_after === "")
                    {
                    
                        //console.log(ui.item[0].previousElementSibling);
                        //console.log(ui.item[0].nextElementSibling);
                        
                        if($(ui.item[0].previousElementSibling).hasClass(group_name) == false)
                        {
                            //se stavo trascinando un sub, e questo è finito in un altro gruppo, allora cancello l'evento
                            $('table tbody .treetable').sortable('cancel');
                        }
                    }
                    else
                    {
                        //se html_after non è vuoto, allora ho trascinato un main ed i suoi sub
                        var prev_group_name = null;
                        var next_group_name = null;
                        
                        var group_name = null;
                    
                        
                        //per verificare se l'utente ha messo il main in un posto corretto devo recuperare il gruppo precedente
                        //e quello successivo alla posizione della riga di destinazione
                        try {
                            var prev_classes = $(ui.item[0].previousElementSibling).attr('class').split(/\s+/);
                            
                            
                            for (var i=0; i< prev_classes.length; i++){
                            
                                if(prev_classes[i].includes("group"))
                                {
                                    prev_group_name = prev_classes[i];
                                }
                            
                            }
                        }
                        catch(err) {
                            
                        }

                    
                    

                        try {
                            var next_classes = $(ui.item[0].nextElementSibling).attr('class').split(/\s+/);
                            
                            
                            for (var i=0; i< next_classes.length; i++){
                            
                                if(next_classes[i].includes("group"))
                                {
                                    next_group_name = next_classes[i];
                                }
                            
                            }
                        }
                        catch(err) {
                            
                        }
                        
                        
                        
                        if((prev_group_name != next_group_name) || prev_group_name == null || next_group_name == null)
                        {
                            //l'utente ha rilasciato il main in un posto valido, appendo anche il codice html dei sub sotto alla riga del main
                            $(ui.item[0]).after(html_after);
                        }
                        else
                        {       
                            //l'utente ha rilasciato il main in un posto non valido, cancello l'evento
                            $('table tbody .treetable').sortable('cancel');
                            
                            //dopo aver cancellato l'evento devo rimettere i sub al loro posto
                            $("#" + row_id).after(html_after);

                        }

                    }
                    
                    //ora devo riordinare l'array che contiene i rettangoli in base al nuovo ordinamento della tabella, poi ridisegno la tabella, così
                    //non rischio di avere righe con codice sporco.
                    
                    var new_index = [];
                    
                    var thumb = $('.thumbnail-container:not(#thumbnail_screen)');
                    
                    for (var i = 0; i< thumb.length; i++)
                    {
                        //l'array new_index contiene i nuovi indici, se ad esempio new_index[0] = 3, significa che poi alla riga 0 dovremo mettere l'elemento
                        //che in boxes (cioè l'array che otteniamo con rectManager.get_rectangles() ) si trova alla posizione 3
                        new_index[i] = parseInt($(thumb[i]).attr("id").replace("thumbnail_",""));
                    }
                    
                    hidden_thumbnail =[];
                    //redraw_treetail();
                    var rects = rectManager.get_rectangles();

                    var group = -1;
                    var thumbnails = []
                    
                    var new_rects = [];
                    
                    var main_g0_created = false;
                    var main_g1_created = false;
                    var main_g2_created = false;

                    var g0_elements_cnt = 0;
                    var g1_elements_cnt = 0;
                    var g2_elements_cnt = 0;

                    for (var i= 0; i<rects.length; i++)
                    {
                        //sistemiamo il conteggio degli elementi nel caso in cui interi gruppi siano stati spostati
                        new_rects.push(rects[new_index[i]]);
                        if (new_rects[i].is_main == true )
                        {
                            group += 1;
                            
                            if(group==0) main_g0_created = true;

                            if(group==1) main_g1_created = true;

                            if(group==2) main_g2_created = true;
                        }
                        
                        if(group==0) g0_elements_cnt+=1;
                        
                        if(group==1) g1_elements_cnt+=1;
                        
                        if(group==2) g2_elements_cnt+=1;
                        
                        new_rects[i].group = group;
                        new_rects[i].thumbnail.group = group;
                        thumbnails.push(new_rects[i].thumbnail);
                    }
                    
                    rectManager.set_rectangles(new_rects);
                    boxes = rectManager.get_rectangles();
                    
                    rectManager.main_g0_created = main_g0_created;
                    rectManager.main_g1_created = main_g1_created;
                    rectManager.main_g2_created = main_g2_created;

                    rectManager.g0_elements_cnt = g0_elements_cnt;
                    rectManager.g1_elements_cnt = g1_elements_cnt;
                    rectManager.g2_elements_cnt = g2_elements_cnt;
                    
                    draw(rectManager.last_mouse_event);
                    createTreeTable({"thumbnails":thumbnails, "screen": old_thumbnail_screen});

                },
                update: function(e, ui){

                    //console.log(ui.item[0].previousElementSibling);
                    //console.log(ui.item[0].nextElementSibling);


                },

                helper: function(e, item){
                    rows_html = [];
                    
                    //l'helper contiene il codice dell'oggetto visibile durante il trascinamento della riga
                    
                    canvas_sorting_ids = [];
                    
                    //recuperiamo l'html dell'elemento che stiamo trascinando
                    var jQelement = $(item[0].innerHTML);
                    
                    var left = jQelement.find("div.thumbnail").css("left");
                    var original_table_height = $('table tbody .treetable').height();
                    
                    //selezioniamo il thumbnail
                    var thumbnail_container = jQelement.find("div.thumbnail-container")[0];
                    
                    var group_name = null;
                    
                    var classes = $(thumbnail_container).attr('class').split(/\s+/);
                    
                    
                    for (var i=0; i< classes.length; i++){
                    
                        if(classes[i].includes("group"))
                        {
                            group_name = classes[i].replace("group-","");
                        }
                    
                    }
                    
                    //questo è il thumbnail del main (o del sub) che stiamo trascinando
                    var element_index = parseInt($(thumbnail_container).attr("id").replace("thumbnail_",""));
                    $(thumbnail_container).attr("id","sorting_container_" + element_index); //cambiamo l'id
                    $(thumbnail_container).css("position", "absolute");
                    $(thumbnail_container).css("z-index", 999); //vogliamo che il nostro elemento sia in cima
                    $(thumbnail_container).addClass("sorting-container");
                    
                    var canvas_container = $(thumbnail_container).find("canvas.canvas-container")[0];
                    var canvas_container_id = $(canvas_container).attr("id");
                    
                    $(canvas_container).attr("id",canvas_container_id + "_sorting");
                    
                    canvas_sorting_ids.push(canvas_container_id + "_sorting" );
                    
                    var subs = []
                    if ($(thumbnail_container).hasClass("is-main"))
                    {
                        
                        //se sto trascinando un main recupero tutti i suoi sub                        
                        subs = $(".thumbnail-container.group-" + group_name + ":not(.is-main)").map(function(index) {

                            var element_index = parseInt($(this).attr("id").replace("thumbnail_",""));
                            
                            rows_html.push($("#thumbnail_row_" + element_index).prop('outerHTML'));
                            
                            var new_html = $(this.outerHTML.replace("thumbnail_" + (element_index),"sorting_container_" + (element_index)));
                            new_html.css("margin-top", 3*(index+1));
                            new_html.css("margin-left", 3*(index+1));
                            new_html.css("z-index", 999-(index+1)); //ogni sub lo porto sotto al precedente abbassando lo z-index
                            new_html.css("position", "absolute");
                            new_html.addClass("sorting-container");
                            
                                                        
                            var canvas_container = $("thumbnail_" + (element_index)).find("canvas.canvas-container")[0];
                            var canvas_container_id = $(canvas_container).attr("id");

                            $(canvas_container).attr("id",canvas_container_id + "_sorting");
                            
                            $(this).removeClass("thumbnail-container");
                            $(this).addClass("sub-of-sorting-main");
                            
                             $("#thumbnail_row_" + element_index).addClass("row-to-remove");
                             $("#thumbnail_row_" + element_index).hide();
                            
                            return new_html.prop('outerHTML');
                        }).get();
                    }
                    
                    var after_table_height = $('table tbody .treetable').height();
                    
                    var diff_height = original_table_height - after_table_height;
                    
                    //costruiamo l'html di ritorno
                    var html_return = "<div id='sorting_tt' style='margin-left: " + left + "; margin-bottom: " + diff_height+ "px;'>"
                    html_return += thumbnail_container.outerHTML;
                    
                    for (var i=0; i< subs.length; i++){

                         html_return += subs[i];
                         var element_index = parseInt($(subs[i]).attr("id").replace("sorting_container_",""));
                         
                         hidden_thumbnail.push(element_index);
                    }
                    
                    console.log(findPosY(document.getElementById('thumbnail_screen').getBoundingClientRect()));
                    
                    html_return += "</div>";
                    
                    return html_return;


                },
            });
            
            createWindow();
        }
        
        function update_context_menu()
        {
            
            ttMenu.hideItem('rem_all');
            ttMenu.hideItem('new_component');
            
            
            if (boxes[selected_box].is_main == true)
            {
                ttMenu.hideItem('remove_comp');
                ttMenu.hideItem('dupl_comp');
                ttMenu.hideItem('set_as_main');
            
                //main
                if (ttMenu.getItemPosition('rem_group') == -1)
                {
                    ttMenu.addNewSibling(null, 'rem_group', 'Remove Group');
                    ttMenu.setHotKey('rem_group', 'Ctrl+X');
                }
                else ttMenu.showItem('rem_group');
                
                if (ttMenu.getItemPosition('dupl_group') == -1)
                {
                    ttMenu.addNewSibling('rem_group', 'dupl_group', 'Duplicate Group');
                    ttMenu.setHotKey('dupl_group', 'Ctrl+D');
                }
                else ttMenu.showItem('dupl_group');
                
                if(rectManager.main_g0_created == true && rectManager.main_g1_created == true && rectManager.main_g2_created == true)
                {
                    ttMenu.setItemDisabled('dupl_group');
                }
                
                if (ttMenu.getItemPosition('detect_as_img') == -1)
                {
                    ttMenu.addNewSibling('dupl_group', 'detect_as_img', 'Detect as Image');
                    ttMenu.setHotKey('detect_as_img', 'Ctrl+I');
                }
                else ttMenu.showItem('detect_as_img');
                
                            
                if (ttMenu.getItemPosition('detect_as_rect') == -1)
                {
                    ttMenu.addNewSibling('detect_as_img', 'detect_as_rect', 'Detect as Rect');
                    ttMenu.setHotKey('detect_as_rect', 'Ctrl+R');
                }
                else ttMenu.showItem('detect_as_rect');
                
                if (ttMenu.getItemPosition('detect_as_text') == -1)
                {
                    ttMenu.addNewSibling('detect_as_rect', 'detect_as_text', 'Detect as Text');
                    ttMenu.setHotKey('detect_as_text', 'Ctrl+T');
                }
                else ttMenu.showItem('detect_as_text');

                if (ttMenu.getItemPosition('new_component') == -1)
                {
                    ttMenu.addNewSibling('detect_as_text', 'new_component', 'New component');
                    ttMenu.setHotKey('new_component', 'Ctrl+N');
                }
                else ttMenu.showItem('new_component');
                
                if((boxes[selected_box].group == 0 && rectManager.g0_elements_cnt == 5) || (boxes[selected_box].group == 1 && rectManager.g1_elements_cnt == 5) || (boxes[selected_box].group == 2 && rectManager.g2_elements_cnt == 5))
                {
                    ttMenu.setItemDisabled('new_component');
                }
                else{
                    ttMenu.setItemEnabled('new_component');
                }
            }
            else
            {
                ttMenu.hideItem('rem_group');
                ttMenu.hideItem('dupl_group');
                
                //sub
                if (ttMenu.getItemPosition('remove_comp') == -1)
                {
                    ttMenu.addNewSibling(null, 'remove_comp', 'Remove Component');
                    ttMenu.setHotKey('remove_comp', 'Ctrl+X');
                }
                else ttMenu.showItem('remove_comp');
                
                if (ttMenu.getItemPosition('dupl_comp') == -1)
                {
                    ttMenu.addNewSibling('remove_comp', 'dupl_comp', 'Duplicate Component');
                    ttMenu.setHotKey('dupl_comp', 'Ctrl+D');
                }
                else ttMenu.showItem('dupl_comp');
                
                                
                if((boxes[selected_box].group == 0 && rectManager.g0_elements_cnt == 5) || (boxes[selected_box].group == 1 && rectManager.g1_elements_cnt == 5) || (boxes[selected_box].group == 2 && rectManager.g2_elements_cnt == 5))
                {
                    ttMenu.setItemDisabled('dupl_comp');
                }
                else{
                    ttMenu.setItemEnabled('dupl_comp');
                }
                
                
                if (ttMenu.getItemPosition('detect_as_img') == -1)
                {
                    ttMenu.addNewSibling('dupl_comp', 'detect_as_img', 'Detect as Image');
                    ttMenu.setHotKey('detect_as_img', 'Ctrl+I');
                }
                else ttMenu.showItem('detect_as_img');
                
                            
                if (ttMenu.getItemPosition('detect_as_rect') == -1)
                {
                    ttMenu.addNewSibling('detect_as_img', 'detect_as_rect', 'Detect as Rect');
                    ttMenu.setHotKey('detect_as_rect', 'Ctrl+R');
                }
                else ttMenu.showItem('detect_as_rect');
                
                if (ttMenu.getItemPosition('detect_as_text') == -1)
                {
                    ttMenu.addNewSibling('detect_as_rect', 'detect_as_text', 'Detect as Text');
                    ttMenu.setHotKey('detect_as_text', 'Ctrl+T');
                }
                else ttMenu.showItem('detect_as_text');
                
                if (ttMenu.getItemPosition('set_as_main') == -1)
                {
                    ttMenu.addNewSibling('detect_as_text', 'set_as_main', 'Set as Main');
                    ttMenu.setHotKey('set_as_main', 'Ctrl+M');
                }
                else ttMenu.showItem('set_as_main');

                if (ttMenu.getItemPosition('new_component') == -1)
                {
                    ttMenu.addNewSibling('set_as_main', 'new_component', 'New component');
                    ttMenu.setHotKey('new_component', 'Ctrl+N');
                }
                else ttMenu.showItem('new_component');
                
                if((boxes[selected_box].group == 0 && rectManager.g0_elements_cnt == 5) || (boxes[selected_box].group == 1 && rectManager.g1_elements_cnt == 5) || (boxes[selected_box].group == 2 && rectManager.g2_elements_cnt == 5))
                {
                    ttMenu.setItemDisabled('new_component');
                }
                else{
                    ttMenu.setItemEnabled('new_component');
                }
                
            }
            
        }
        
        function update_context_menu_screen()
        {
            ttMenu.hideItem('remove_comp');
            ttMenu.hideItem('dupl_comp');
            ttMenu.hideItem('set_as_main');
            
            ttMenu.hideItem('detect_as_img');
            ttMenu.hideItem('detect_as_rect');
            ttMenu.hideItem('detect_as_text');

            ttMenu.hideItem('rem_group');
            ttMenu.hideItem('dupl_group');

            //ttMenu.addNewSibling('t1', 't01', 'Top 01');
            
            if (ttMenu.getItemPosition('rem_all') == -1)
            {
                ttMenu.addNewSibling(null, 'rem_all', 'Remove all');
                ttMenu.setHotKey('rem_all', 'Ctrl+X');
            }
            else ttMenu.showItem('rem_all');
            
            
            if (ttMenu.getItemPosition('new_component') == -1)
            {
                ttMenu.addNewSibling('rem_all', 'new_component', 'New component');
                ttMenu.setHotKey('new_component', 'Ctrl+N');
            }
            else ttMenu.showItem('new_component');
            
            if(rectManager.g0_elements_cnt == 5 && rectManager.g1_elements_cnt == 5 && rectManager.g2_elements_cnt == 5)
            {
                ttMenu.setItemDisabled('new_component');
            }
            else{
                ttMenu.setItemEnabled('new_component');
            }
            
            //Remove all (CTRL+X) confermation popup!
            //New component (CTRL+N)
        }
        
        function redraw_treetail()
        {
               
                                
            var thumbnail_screen_y = findPosY(document.getElementById('thumbnail_screen').getBoundingClientRect());
            
            $(".thumbnail-container:not(#thumbnail_screen, .sorting-container)").map(function() {
                
                    //thumbnail_screen_y;
                    
                    var index = parseInt($(this).attr("id").replace("thumbnail_", ""));
                    
                    if (hidden_thumbnail.includes(index) == false )
                    {
                                                
                        var is_main= false;
                        
                        var parent_pos = thumbnail_screen_y;
                        
                        
                        
                        if ($(this).hasClass('is-main') == true)
                        {
                            //main_index = index;
                            parent_pos = thumbnail_screen_y;
                        }
                        else
                        {
                            
                            var classes = $(this).attr('class').split(/\s+/);
                            var group_class = null;
            
            
                            for (var i=0; i< classes.length; i++){
                            
                                if(classes[i].includes("group"))
                                {
                                    group_name = classes[i];
                                }
                            
                            }
                            
                            var main_id = $("." + group_name + ".is-main").attr("id");
                            
                            parent_pos = findPosY(document.getElementById(main_id).getBoundingClientRect());
                        }

                        var thumbnail_y = findPosY(document.getElementById('thumbnail_' + index).getBoundingClientRect());
                        
                        var difference_y = thumbnail_y - parent_pos;
                        
                        var tail = $("#tail_" + index);
                        
                        tail.css("height",difference_y);
                    }

                    
                });
        }
        
        function findPosX(obj)
          {
            var curleft = 0;
            if(obj.offsetParent)
                while(1) 
                {
                  curleft += obj.offsetLeft;
                  if(!obj.offsetParent)
                    break;
                  obj = obj.offsetParent;
                }
            else if(obj.x)
                curleft += obj.x;
            return curleft;
          }

          function findPosY(obj)
          {
            var curtop = 0;
            if(obj.offsetParent)
                while(1)
                {
                  curtop += obj.offsetTop;
                  if(!obj.offsetParent)
                    break;
                  obj = obj.offsetParent;
                }
            else if(obj.y)
                curtop += obj.y;
            return curtop;
          }
        
        //edge bug: https://developer.microsoft.com/en-us/microsoft-edge/platform/issues/7628560/

        class Box {

            constructor(x, y, w, h, roi_x, roi_y, roi_w, roi_h) {
                this.x = x;
                this.y = y;
                this.w = w;
                this.h = h;
                this.roi_x = roi_x;
                this.roi_y = roi_y;
                this.roi_w = roi_w;
                this.roi_h = roi_h;
                this.roi_unlimited_left = false;
                this.roi_unlimited_up = false;
                this.roi_unlimited_right = false;
                this.roi_unlimited_down = false;
                this.group = 0;
                this.is_main = false;
                
                this.thumbnail = {};
                
                this.type = "I";
                
                /*this.features = {"I":{"colors": true, "likelihood": 0.7},
                                    "R":{"width": {"min": 5, "max": 5}, "height": { "min": 15, "max": 15}},
                                    "T":{"regexp": "", "whitelist": "", "dictionary": "en"}};*/
                                    
                this.features = {"I":{"colors": true, "likelihood": 0.9},
                                    "R":{},
                                    "T":{}};
                                    
                this.mouse = {"type": null, "features": {"point": { "dx": 0, "dy": 0 }}};
                
                this.keyboard = { "string": "", "delays_ms": 100, "durations_ms": 100};

            }

        }
        
        var canvas = null;
        var ctx = null;
        var dpi = null;
        
        var screen_w = 0;
        var screen_h = 0;
        
        var boxes = []
        
        var id_counter=0;

        var rectManager = new RectManager();
        
        var background_base64_string = "{{base64url}}";
        
        {% for o in autocontoured_rects %}
        rectManager.autocontoured_rects.push(new Box({{o[0]}}, {{o[1]}}, {{o[2]}}, {{o[3]}}, 0, 0, 0, 0));
        {% endfor %}
        
        var jsonData = JSON.stringify({box_list:boxes, background: background_base64_string});
            
        this.deleted_rects = [];
             
            
        $.ajax({
            url: "/load_objects",
            type: "GET",
            contentType: "application/json; charset=utf-8",
            success: function(dat) { console.log(dat); build_objects_from_file(dat["file_dict"], dat["autocontoured_rects"])}
        });
        
        function build_objects_from_file(file_dict, autocontoured_rects){
        
            if (jQuery.isEmptyObject(file_dict))
            {
                return;
            }
            
            rectManager.autocontoured_rects = [];
            
            for(i=0; i<autocontoured_rects.length; i++)
            {
                rectManager.autocontoured_rects.push( new Box(autocontoured_rects[i][0], autocontoured_rects[i][1], autocontoured_rects[i][2], autocontoured_rects[i][3], 0, 0, 0, 0));
            }
        
            boxes = [];
            rectManager.set_rectangles(boxes);
        
            var boxes_json = file_dict['boxes'];
            
            background_base64_string = "data:image/png;base64," + file_dict["screen"];

            $( "body" ).css("background-image", "url('" + background_base64_string + "')");
         
            screen_h = file_dict['img_h'];
            screen_w = file_dict['img_w'];

            console.log('width =' + screen_w + ', height = ' + screen_h)    ;
                
            $("body").css({ "background-size": screen_w.toString() + "px " + screen_h.toString() + "px"});  
            
            
            for(i=0; i<boxes_json.length; i++)
            {
                    var box_json = boxes_json[i];
                    var box = new Box(box_json["x"], box_json["y"], box_json["w"], box_json["h"], box_json["roi_x"], box_json["roi_y"], box_json["roi_w"], box_json["roi_h"]);
                    
                    box.roi_unlimited_left = box_json["roi_unlimited_left"];
                    box.roi_unlimited_up = box_json["roi_unlimited_up"];
                    box.roi_unlimited_right = box_json["roi_unlimited_right"];
                    box.roi_unlimited_down = box_json["roi_unlimited_down"];
                    box.group = box_json["group"];
                    box.is_main = box_json["is_main"];
                    
                    if (box.is_main)
                    {
                        if(box.group==0) rectManager.main_g0_created = true;

                        if(box.group==1) rectManager.main_g1_created = true;

                        if(box.group==2) rectManager.main_g2_created = true;
                    }
                    
                    if(box.group==0) rectManager.g0_elements_cnt+=1;
                    
                    if(box.group==1) rectManager.g1_elements_cnt+=1;
                    
                    if(box.group==2) rectManager.g2_elements_cnt+=1;
                    
                    box.type = box_json["type"];
                                        
                    box.features = box_json["features"];
                                        
                    box.mouse = box_json["mouse"];
                    
                    box.keyboard = box_json["keyboard"];
                
                    boxes.push(box);
            
            }
            
            rectManager.set_rectangles(boxes);
            draw();
        
        }
        
        /*{% for o in loaded_boxes %}

        var curr_box =  new Box({{o.x}}, {{o.y}}, {{o.w}}, {{o.h}}, {{o.roi_x}}, {{o.roi_y}}, {{o.roi_w}}, {{o.roi_h}});
        
        curr_box.is_main = {{o.is_main}};
        
        curr_box.is_main = {{o.is_main}};
        
        curr_box.group = {{o.group}};
        
        curr_box.type = '{{o.type}}'; 
        
        curr_box.features = {{o.features|safe}}; 
        
        curr_box.roi_unlimited_left = {{o.roi_unlimited_left}};
        curr_box.roi_unlimited_up = {{o.roi_unlimited_up}};
        curr_box.roi_unlimited_right = {{o.roi_unlimited_right}};
        curr_box.roi_unlimited_down = {{o.roi_unlimited_down}};
        
        curr_box.mouse = {{o.mouse|safe }};
        curr_box.keyboard = {{o.keyboard|safe}};
        
        boxes.push(curr_box);
        {% endfor %}*/
        
        rectManager.set_rectangles(boxes);
  
        $(window).on("load",function() {
        
            
            //var box1 = new Box(id=1, main=0, x=365, y=413, w=356, h=197, 340,370,436,277);
            //var box2 = new Box(id=2, main=0, x=1011, y=359, w=162, h=295, 970,319,242,375);
            
            //boxes.push(box1);
            //boxes.push(box2);
            
            rectManager.set_rectangles(boxes);
        
            //alert("sdsd");
            //get the canvas, canvas context, and dpi
            canvas = document.getElementById('myCanvas');
            ctx = canvas.getContext('2d');
            dpi = window.devicePixelRatio || 1;
            //dpi = 1;

            //alert("sdsd");
            
            //var element = document.getElementsByTagName("myCanvas")[0];
            //onResize( element, function(){ alert("Woo!"); } );
            
            $( document ).on( "mousemove", function( event ) {
                //console.log("pageY: " + event.pageY );
                curr_mouse_y = event.pageY ;
            });
            
            $("#myCanvas").mousemove(function(e){handleMouseMove(e);});
            
            $("#myCanvas").mousedown(function(e){rectManager.mousedown(e);});
            
            $("#myCanvas").mouseup(function(e){rectManager.mouseup(e);});
            
            $("body").keydown (function(e){rectManager.keydown(e);});
            
            //rectManager.openwindow_
            
            $("body").keyup(function(e){rectManager.keyup(e);});
            
            $(window).keydown(function(event) 
            {
                if((event.keyCode == 107 && event.ctrlKey == true) || (event.keyCode == 109 && event.ctrlKey == true))
                {
                    event.preventDefault(); 
                }
                
                

                $(window).bind('mousewheel DOMMouseScroll', function(event) 
                {
                    if(event.ctrlKey == true)
                    {
                        event.preventDefault(); 
                    }
                });
            });
            
            //var imageSrc =  $( "body" ).css('background-image').replace(/url\((['"])?(.*?)\1\)/gi, '$2').split(',')[0];
            $( "body" ).css("background-image", "url('" + background_base64_string + "')");
         
            screen_h = {{img_h}};
            screen_w = {{img_w}};

            console.log('width =' + screen_w + ', height = ' + screen_h)    ;
                
            $("body").css({ "background-size": screen_w.toString() + "px " + screen_h.toString() + "px"});  
            draw();
        });
        
        
        function fix_dpi() {
            if (ctx==null) return;
            //create a style object that returns width and height
              let style = {
                height() {
                  return +getComputedStyle(canvas).getPropertyValue('height').slice(0,-2);
                },
                width() {
                  return +getComputedStyle(canvas).getPropertyValue('width').slice(0,-2);
                }
              }
              
              //alert(dpi);
            //set the correct attributes for a crystal clear image!
              canvas.setAttribute('width', style.width()*dpi);
              canvas.setAttribute('height', style.height()*dpi);
              ctx.scale(dpi, dpi);
              //alert(dpi)
              //canvas.style.background = "red";  // a valid CSS colour.
              

            }
            
            
        function draw(e=null) {
            if (ctx==null) return; 

            //call the dpi fix every time 
            //canvas is redrawn
            fix_dpi();
            
            //canvas = document.getElementById("myCanvas");
            //ctx = canvas.getContext("2d");

            //ctx.clearRect(0, 0, +getComputedStyle(canvas).getPropertyValue('width').slice(0,-2), +getComputedStyle(canvas).getPropertyValue('height').slice(0,-2));
            ctx.translate(0.5, 0.5); //to eliminate blur effect

            ctx.lineWidth = 1;

            //draw stuff!
            
            //ctx.strokeStyle = '#ff0000';
            //ctx.fillStyle = '#ff00ff';
            
            ctx.strokeStyle = '#0000ff';
            ctx.fillStyle = '#00aaff';
            
            if(rectManager.show_autocontoured_rects == true)
            {
                var rects = rectManager.get_rectangles();
                var autocontoured_rects = rectManager.get_autocontoured_rects();
            
                for(i=0; i<autocontoured_rects.length; i++)
                {
                    var autocontoured_box = autocontoured_rects[i];
                    
                    /*if(rectManager.group == 0)
                    {
                        ctx.strokeStyle = '#ff0000';
                        ctx.fillStyle = '#ff00ff'; 
                    }
                    else if (rectManager.group == 1)
                    {
                        ctx.strokeStyle = '#0000ff';
                        ctx.fillStyle = '#0072ff';
                    }
                    else if (rectManager.group == 2)
                    {
                        ctx.strokeStyle = '#009500';
                        ctx.fillStyle = '#00bc00';
                    }
                    */
                   
                    var match = false;

                    for(j=0; j<rects.length; j++)
                    {

                        var box = rects[j];
                        if(box.x == autocontoured_box.x && box.y == autocontoured_box.y &&
                            box.w == autocontoured_box.w && box.h == autocontoured_box.h)
                            {
                                if(box.group == 0)
                                {
                                    ctx.strokeStyle = '#ff0000';
                                    ctx.fillStyle = '#ff00ff'; 
                                } 
                                else if (box.group == 1)
                                {
                                    ctx.strokeStyle = '#009500';
                                    ctx.fillStyle = '#00bc00';
                                }
                                else if (box.group == 2)
                                {
                                    ctx.strokeStyle = '#0000ff';
                                    ctx.fillStyle = '#0072ff';
                                } 
                                
                                rectManager.draw_autocontoured_rect(ctx, box);
                                match = true; 
                            }
                        
                    }  
                     
                    if (match == false)
                    {

                        ctx.strokeStyle = '#656193';
                        ctx.globalAlpha=0.3;
                        ctx.fillStyle="#515285"; 
                        ctx.fillRect(autocontoured_box.x, autocontoured_box.y,
                                    autocontoured_box.w, autocontoured_box.h);
                                    
                        ctx.globalAlpha=1;
                                    
                        ctx.strokeRect(autocontoured_box.x, autocontoured_box.y,
                                      autocontoured_box.w, autocontoured_box.h);
                                            
                    }

                    
                    ctx.fillStyle = '#AC60F6';
                }
            }
            else
            {
                        
                var rectangles = rectManager.get_rectangles();
            
                for(i=0; i<rectangles.length; i++)  
                {
                    var box = rectangles[i];
                    
                    if(box.group == 0)
                    {
                        ctx.strokeStyle = '#ff0000';
                        
                        if (box.is_main) ctx.fillStyle = '#ff00ff';
                        else ctx.fillStyle = '#ff00ff'; //'#AC60F6';
                    }
                    else if (box.group == 1)
                    {
                        ctx.strokeStyle = '#009500';
                        if (box.is_main) ctx.fillStyle = '#00bc00';
                        else ctx.fillStyle = '#00bc00'; //'#4ca737';
                    }
                    else if (box.group == 2)
                    {

                        ctx.strokeStyle = '#0000ff';
                        if (box.is_main) ctx.fillStyle = '#0072ff';
                        else ctx.fillStyle = '#0072ff'; //'#50a5d6';
                    }
                    
                    rectManager.draw_rect(ctx, box);
                    
                    
                    ctx.fillStyle = '#AC60F6';
                }
                
                if(e != null && rectManager.capturing_rect == true)
                {
                            
                    var mouseX=parseInt(e.clientX);
                    var mouseY=parseInt(e.clientY);
                    
                    //ctx.strokeStyle = '#00ff00';
                    

                                    
                    ctx.globalAlpha=0.3;
                    //ctx.fillStyle="#20b2aa"; 
                    
                    
                    if(rectManager.group == 0)
                    {
                        ctx.strokeStyle = '#ff0000';
                        ctx.fillStyle = '#ff00ff';
                    }
                    else if (rectManager.group == 1)
                    {
                        ctx.strokeStyle = '#009500';
                        ctx.fillStyle = '#00bc00';
                    }
                    else if (rectManager.group == 2)
                    {

                        ctx.strokeStyle = '#0000ff';
                        ctx.fillStyle = '#0072ff';
                    }
                    
                    
                    
                    ctx.fillRect(rectManager.click_position_x, rectManager.click_position_y,
                                    mouseX - rectManager.click_position_x, mouseY - rectManager.click_position_y);
                                    
                    ctx.globalAlpha=1;
                                    
                    ctx.strokeRect(rectManager.click_position_x, rectManager.click_position_y,
                                    mouseX - rectManager.click_position_x, mouseY - rectManager.click_position_y);
                }
                    
                
                if(e != null && rectManager.border_index == null && rectManager.move_index == null &&
                    rectManager.mouse_is_on_border == null && rectManager.mouse_is_inside_rectangle == null && ttWIndow_isOpen == false)
                {
                
                    mouseX=parseInt(e.clientX);
                    mouseY=parseInt(e.clientY);
                    
                    //ctx.fillStyle = '#AC60F6';
                    
                    if (rectManager.group == 0)
                    {
                        ctx.strokeStyle = '#ff00ff';
                        ctx.globalAlpha=0.7;
                    }
                    
                    if (rectManager.group == 1)
                    {
                        ctx.strokeStyle = '#00bc00';
                        ctx.globalAlpha=0.7;
                    }
                    
                    if (rectManager.group == 2)
                    {

                        ctx.strokeStyle = '#0072ff';
                        ctx.globalAlpha=0.7;
                    }
                    

                    

                    //draw line
                    ctx.beginPath();
                        //ctx.lineWidth = 0.5;
                        //vertical top
                        //ctx.lineDashOffset = 2;
                        
                                            
                        //ctx.moveTo(0, mouseY -5);
                        //ctx.lineTo(+getComputedStyle(canvas).getPropertyValue('width').slice(0,-2) - 900, mouseY -5);
                        //ctx.stroke();
                        
                        //ctx.setLineDash([0.5,1.5]); //larghezza dot, larghezza spazio
                        
                        ctx.moveTo(mouseX, 0);
                        ctx.lineTo(mouseX, +getComputedStyle(canvas).getPropertyValue('height').slice(0,-2));

                        ctx.moveTo(0, mouseY);
                        ctx.lineTo(+getComputedStyle(canvas).getPropertyValue('width').slice(0,-2), mouseY);



                        //ctx.strokeStyle = '#000000';
                        ctx.stroke();
                    
                    ctx.closePath();
                    //ctx.translate(-0.5, -0.5);
                    
                }
            }
            
        }
            
        $(window).resize(function(){
            //$('#canvas').height($('#canvas').width() / 2.031);
            
           /*             var imageSrc = $("#myCanvas").css('background-image').replace(/url\((['"])?(.*?)\1\)/gi, '$2').split(',')[0];
                        
            //alert(imageSrc);

            // I just broke it up on newlines for readability        

            var image = new Image();
            image.src = imageSrc;

            var width = image.width/dpi,
                height = image.height/dpi;

            //alert('width =' + width + ', height = ' + height)    


                
                $("#myCanvas").css({ cursor: "crosshair" });
                $("#myCanvas").css({ "background-size": width.toString() + "px " + height.toString() + "px"});  */
                
            draw();
        });
        
        
        function handleMouseMove(e){
            if(canvas==null) return;
            // tell the browser we're handling this event
            //e.preventDefault();
            //e.stopPropagation();
            draw(e);
            rectManager.mousemove(e);

        }


        
        
    </script>
</head>
<body onload="doOnLoad();" onunload="doOnUnload();">
    <canvas id='myCanvas' oncontextmenu="return false;" tabindex='1'></canvas>
    <div id='myDiv'></div>
    

    
    <div id="tt_window" style="display: none; width:100%">
    <table id="tt_window_table" style="border:none; width:100%; height: 400px;" border="0" cellspacing="0" cellpadding="0">
    <tbody>
    
                <tr id="object_name_option" >
                <td>
                    <table style="border:none;" border="0" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>
                            <td>{{ text.label_object_name }}:</td>
                            <td><input type="text" value="{{object_name}}" name="object_name" style="width: 100%;" oninput="object_name_change(this);"></td>
                        </tr>
                    </tbody>
                    </table>
                </td>
            </tr>
            <tr id="app_disapp_option">
                <td>
                    <table style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>

                            <td><input type="radio" name="find_type" onclick="appear_click();" value="appear"> {{text.label_appear}}</td>
                            <td><input type="radio" name="find_type" onclick="appear_disappear_click();" value="appear_disappear"> {{text.label_a_d}}</td>
                            <td><input type="radio" name="find_type" onclick="disappear_click();" value="disappear"> {{text.label_disappear}}</td>
                        </tr>   
                    </tbody>
                    </table>
                </td>

            </tr>
            <tr id="timeout_option">
                <td>
                    <table style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>
                            <td>{{text.label_timeout}}<INPUT TYPE="NUMBER" name="timeout_s" MIN="1" MAX="9999" STEP="1" VALUE="10" SIZE="6" oninput="timeout_s_change(this);"></td>
                            <td>{{text.label_break}}<input type="checkbox" name="break" value="break" onclick="break_click(this);"></td>
                        </tr>   
                    </tbody>
                    </table>


    </td></tr>
    
    <tr>
        <td><div id="tt_row" style="overflow-y:auto; height:350px;"></div></td>
    </tr>
    
                 <tr id="add_irt_button" style="display: none;">
                    <td>
                        <table style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                        <tbody>
                            <tr>
                                <td><button id="toggle_Add" type="button" onclick="add_object_button();">Add</button></td>
                                <td><button id="toggle_I" type="button" onclick="change_object_type_by_button('I');">I</button></td>
                                <td><button id="toggle_R" type="button" onclick="change_object_type_by_button('R');">R</button></td>
                                <td><button id="toggle_T" type="button" onclick="change_object_type_by_button('T');">T</button></td>
                            </tr>    
                        </tbody>
                        </table>
                    </td>
                </tr>

                <tr id="detection_option" style="display: none;">
                    <td>
                        <table id="image_options" style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                        <tbody>
                            <tr>
                                <td><input type="radio" name="img_match_type" value="match" onclick="image_type_match_click();"> {{text.label_match}}</td>
                                <td><input type="radio" name="img_match_type" value="color" onclick="image_type_color_click();"> {{text.label_color}}</td>
                                <td><input type="radio" name="img_match_type" value="shape" onclick="image_type_shape_click();"> {{text.label_shape}}</td>
                            </tr>   
                        </tbody>
                        </table>
                        
                        <table id="rect_options" style="display: none; border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                        <tbody>
                            <tr>
                                <td><input type="radio" name="rect_match_type" value="button" onclick="rect_type_button_click();"> {{text.label_button}}</td>
                                <td><input type="radio" name="rect_match_type" value="box" onclick="rect_type_box_click();"> {{text.label_box}}</td>
                                <td><input type="radio" name="rect_match_type" value="window" onclick="rect_type_window_click();"> {{text.label_window}}</td>
                            </tr>   
                        </tbody>
                        </table>
                        
                        <table id="text_options" style="display: none; border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                        <tbody>
                            <tr>
                                <td><input type="radio" name="text_match_type" value="detect" onclick="text_type_detect_click();"> {{text.label_detect}}</td>
                                <td><input type="radio" name="text_match_type" value="scrap" onclick="text_type_scrap_click();"> {{text.label_scrap}}</td>
                                 <td> {{text.label_scrap}}<br/><input type="text" name="scraped" readonly></td>
                            </tr>   
                            <tr>
                                <td colspan="2"> {{text.label_regexp}}<br/><input id="input_box_regexp" type="text" name="regexp" onInput="regexp_change(event)"></td><td><div style="background-color: #00ff00; width: 20px; height:20px; border-radius: 50%;"></div></td>
                                
                            </tr>   
                        </tbody>
                        </table>
                    </td>
                </tr>
                <tr id="interaction_mouse_option" style="display: none;">
                <td>
                    <table id="mouse_options" style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                    <tbody>
                        <tr>
                            <td colspan="2">{{text.label_interaction_type}}<br/>
                            <select name="mouse_interaction_type" id="values_interaction_type" onchange="interaction_change(this);" >

                                {% for o in text.values_interaction_type %}
                                <option value="{{ o[0] }}">{{ o[1] }}</option>
                                {% endfor %}

                            </select>
                            </td>
                            <td colspan="2"><div id="mouse_set_point"> {{text.label_interaction_point}}<br/><button id="set_point_button" type="button" onclick="mouse_set_point_click(this);">{{text.label_set_point}}</button></div></td>
                        </tr>   
                        <tr>
                            <td><div id="mouse_button_l"><input type="radio" name="mouse_button" value="left" onclick="mouse_left_click();" ><br/>{{text.label_left}}</div></td>
                            <td><div id="mouse_button_r"><input type="radio" name="mouse_button" value="right" onclick="mouse_right_click();"><br/>{{text.label_right}}</div></td>
                            <td><div id="mouse_units">{{text.label_units}}<br/><INPUT TYPE="number" MIN="1" MAX="999" STEP="1" VALUE="10" SIZE="6" name="mouse_units" oninput="mouse_units_change(this);"></div></td>
                            <td><div id="mouse_delays">{{text.label_delay}}<br/><INPUT TYPE="number" MIN="1" MAX="1000" STEP="1" VALUE="100" SIZE="6" name="mouse_delay" oninput="mouse_delay_change(this);" ></div></td>

                        </tr>   
                        
                        <tr>
                            <td colspan="2"><div id="mouse_direction">{{text.label_direction}}<br/>
                            <select name="mouse_direction" id="values_direction" oninput="mouse_direction_change(this);">

                                {% for o in text.values_direction %}
                                <option value="{{ o[0] }}">{{ o[1] }}</option>
                                {% endfor %}

                            </select></div>
                            </td>
                            <td><div id="mouse_pixels">{{text.label_pixels}}<br/><INPUT TYPE="NUMBER" MIN="1" MAX="10000" STEP="1" VALUE="100" SIZE="6" name="mouse_pixels" oninput="mouse_pixels_change(this);"></div></td>

                        </tr>   

                    </tbody>
                    </table>
                </td>
                </tr>
                <tr id="interaction_keyboard_option" style="display: none;">
                <td>
                    <table id="string_options" style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                    <tbody>

                        <tr>
                            <td>{{ text.label_string}}</td>
                            
                            <td><input type="text" name="interaction_string" style="width: 200px;" oninput="interaction_string_change(this);"></td>

                        </tr>   

                    </tbody>
                    </table>
                </td>
                </tr>
                
                <tr id="ok_cancel">
                <td>
                    <table id="string_options" style="border:none; width:100%;" border="0" cellspacing="0" cellpadding="0">
                    <tbody>

                        <tr>
                            <td><button type="button" onclick="save();">{{text.label_ok}}</button></td>
                            
                            <td><button type="button" onclick="cancel();">{{text.label_cancel}}</button></td>

                        </tr>   

                    </tbody>
                    </table>

    </td></tr>
    

    </tbody>
    </table>
    </div>
    
</body>
</html>
